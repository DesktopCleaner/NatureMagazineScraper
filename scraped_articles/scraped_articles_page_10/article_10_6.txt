*** The brain functions as a prediction machine, utilizing an internal model of the world to anticipate sensations and the outcomes of our actions. Discrepancies between expected and actual events, referred to as prediction errors, are leveraged to update the internal model and guide our attention towards unexpected events1,2,3,4,5,6,7,8,9,10. Despite the importance of prediction-error signals for various neural computations across the brain, surprisingly little is known about the neural circuit mechanisms responsible for their implementation. Here we describe a thalamocortical disinhibitory circuit that is required for generating sensory prediction-error signals in mouse primary visual cortex (V1). We show that violating animals’ predictions by an unexpected visual stimulus preferentially boosts responses of the layer 2/3 V1 neurons that are most selective for that stimulus. Prediction errors specifically amplify the unexpected visual input, rather than representing non-specific surprise or difference signals about how the visual input deviates from the animal’s predictions. This selective amplification is implemented by a cooperative mechanism requiring thalamic input from the pulvinar and cortical vasoactive-intestinal-peptide-expressing (VIP) inhibitory interneurons. In response to prediction errors, VIP neurons inhibit a specific subpopulation of somatostatin-expressing inhibitory interneurons that gate excitatory pulvinar input to V1, resulting in specific pulvinar-driven response amplification of the most stimulus-selective neurons in V1. Therefore, the brain prioritizes unpredicted sensory information by selectively increasing the salience of unpredicted sensory features through the synergistic interaction of thalamic input and neocortical disinhibitory circuits.

*** Although our senses are continuously bombarded with inputs from the environment, only a subset of the sensory information is perceived or affects behaviour. Our brains thus prioritize important sensory features among irrelevant ones11. Psychological and physiological studies indicate that the brain generates internal predictions about incoming sensory information and compares them with actual sensory inputs5,6,7,8,9,10, resulting in prediction errors when sensory inputs do not match internal predictions. Error signals could mediate prioritization of unexpected—and therefore possibly relevant—sensory inputs, and be used to update internal predictions5,6,7,8,9,10. Indeed, sensory prediction-error signals have been observed in multiple cortical areas upon the violation of subjects’ predictions9,10,12,13,14,15,16. Despite their prevalence across the brain and importance for perception and learning, it is still unclear what information is encoded by sensory prediction error signals, how they affect cortical networks, and through which circuit mechanisms they arise.

*** To study the neural implementation of predictive processing in cortical sensory networks, we used a paradigm in which head-fixed, food-deprived mice running on a cylinder navigated a virtual corridor in which they developed spatial predictions about stimulus identity at particular locations along the corridor. The corridor walls displayed alternating grating stimulus patterns (grating A–grating B–grating A–grating B) separated by distinct landmarks (Fig.1a). The visual stimuli appeared abruptly when mice reached the corresponding position in the corridor and were presented at constant visual flow independent of the running speed of the mice, to enable precise control over stimulus features and timing (Methods). Upon reaching the reward zone at the end of the corridor, mice received a liquid food reward and their position was reset to the beginning of the corridor, starting a new trial. Mice traversed the corridor many times for five days of training (90 ± 48 trials (traversals) per day, 59 ± 21 s per trial; mean ± s.d.) during which the sequence of the gratings was identical on every trial. On day six (C session), the identity of the stimulus at the fourth position changed in a subset of trials: a novel grating stimulus C was first shown instead of the second grating stimulus B in 10% of trials (block 1, 160 trials in total; Fig.1a). Subsequently, stimulus C was shown at the fourth location in all trials (block 2, 40 trials). Previous studies using similar paradigms showed that mice form predictions of which stimuli to expect at specific locations in the corridor14,17. Accordingly, we found that mice interrupted their running behaviour when their expectations were violated by encountering stimulus C (Extended Data Fig.1a,b), although running speed was not always a reliable behavioural indicator of the increasing familiarity of the novel stimulus with repeated exposure (Extended Data Fig.1a,b).

*** a, Structure of the virtual corridor and experimental design.b, Two-photon calcium imaging approach.c, Average calcium responses to different stimuli in corridor traversals with unexpected C (red, in block 1) and with expected C (blue, in late block 2). V1 neurons responsive to the presented stimulus in unexpected C trials, expected C trials or both were included. Dotted vertical lines indicate grating onsets. Data from 9 mice;Pvalues from hierarchical bootstrapping test. See also Extended Data Fig.2bfor combined responses of all grating-responsive neurons.d, Average calcium responses to stimuli C4 (dark grey) and A3 (light grey) during C trials across trials and blocks.e, Thought experiment to disambiguate information represented by prediction errors.f, Experimental design. Stimulus C was presented at position 2 (C2) or at position 3 (C3) in 5% of trials each in block 1.g, Average calcium responses to unexpected (red) and expected (blue) stimuli C2 (top) and C3 (bottom). Data from 9 mice,Pvalues from hierarchical bootstrapping test.h, Responses to unexpected stimulus C2 plotted against responses to unexpected C3 for individual V1 layer 2/3 neurons; Pearson correlation.i, Difference in response strength between unexpected and expected C2 plotted against response strength difference between unexpected and expected C3 responses for individual V1 layer 2/3; Pearson correlation.j, Similar toe, but for a second thought experiment. Exp., expected; unexp., unexpected.k, Experimental design. Stimuli C or D were presented at position 4 (C4 and D4) in 10% of trials in different sessions.l, Same asg, but for stimuli C4 (top) and D4 (bottom). Data from 5 mice.m, Same ash, but for stimuli C4 and D4.n, Same asi, but for stimuli C4 and D4.c,d,g,l, Data are mean ± bootstrap 95% confidence intervals. See also Extended Data Figs.1–3.

*** Source Data

*** We recorded neural activity of layer 2/3 neurons in V1 using two-photon calcium imaging18(Fig.1bandMethods), and observed a stronger response to a visual stimulus that was novel and therefore unexpected (stimulus C in block 1) compared with the same stimulus when it was expected (stimulus C in second half of block 2,P< 1 × 10−4, hierarchical bootstrapping test; Fig.1cand Extended Data Fig.2a,b), consistent with previous studies in humans, non-human primates and rodents9,10,12,13,14,16,19,20,21,22,23. This difference in neural responses could not be explained by a drift in general behavioural state, such as arousal or task engagement across the imaging session, as responses to expected grating stimuli A and B were constant throughout the session (Fig.1c,d, allP>  0.05; see also Extended Data Fig.2a, b). The increased response to unexpected visual stimuli could also not be accounted for by changes in the animal’s motor behaviour (Extended Data Fig.1). Specifically, the response increase was not correlated with running speed, stimulus-induced deceleration or pupil size (Extended Data Fig.1). V1 responses to an unexpected stimulus were slightly larger when this stimulus was encountered closer to the reward location (Extended Data Fig.3a–c), consistent with potentially higher behavioural relevance of visual stimuli at such a location17. However, the increased neural responses to unexpected stimuli were independent of reward-related signals in V1 (Extended Data Fig.3c–e).

*** Neural responses to grating stimulus C strongly decreased over time as mice encountered the visual stimulus more often, and responses were asymptotic within several trials in block 2 when stimulus C was encountered in every trial (Fig.1dand Extended Data Fig.2g). This gradual decrease in response cannot simply be explained by visual adaptation to repetitive stimuli, as C was only presented every 448 ± 364 s (mean ± s.d.) in block 1, owing to the considerable length of the virtual corridor. Of note, responses also significantly increased when the familiar stimulus A was presented at an unexpected location in the corridor (Extended Data Fig.4a–d,P< 1 × 10−4), and some neurons responded to the omission of an expected stimulus14(Extended Data Fig.2e,f,P< 1 × 10−4for visual stimulus omission). The elevated neural response to an unexpected stimulus does thus not only constitute a response to stimulus novelty, but also is most consistent with a prediction-error signal. Moreover, the gradual decrease and eventual cessation of the prediction-error signal after repeated exposure to the novel stimulus at the same location indicates that mice learned to update their spatial expectations about stimulus identity over time.

*** What information sensory prediction error signals represent is currently unclear. According to theories of predictive coding, prediction error signals have been proposed to encode the difference between predicted and actual visual input5,6,7,8(encoding the content of how the actual visual input is different from predictions). However, error responses could also represent a more unspecific surprise signal, encoding only the magnitude of the deviation without its content (also called unsigned prediction error9), or could enhance the representation of unpredicted sensory input (encoding the content of the actual input). We designed further experiments to disambiguate between these options. First, in a small subset of trials, we presented stimulus C at one of two different locations in the corridor, at which either stimulus B (position 2) or stimulus A (position 3) were expected (experiment 1; Fig.1e,f). Grating stimulus C elicited a stronger response in V1 in either location when it was unexpected (Fig.1g). In these two instances the actual visual stimulus is the same, but the predictions are likely to be different. If the prediction-error signal contains information about the predicted stimulus and/or how the actual stimulus deviates from this prediction, V1 responses should differ to stimulus C at the two different locations. However, V1 prediction-error responses to the unexpected stimulus C in the two locations were notably similar (Fig.1h,i;r= 0.91,P= 1.6 × 10−199andr= 0.80,P= 1.8 × 10−122(Pearson correlation for Fig.1h,i, respectively); Extended Data Fig.3g), indicating that—at least at the level of individual neurons in V1—the sensory prediction-error signal contains little information about how the actual input differs from predictions.

*** Next, we tested whether the prediction-error signal represents the actual visual input or instead a non-specific surprise or motor-related signal (experiment 2; Fig.1j,k). To this end we introduced an additional unexpected visual stimulus D that was presented at corridor position 4 in a subset of trials in a separate imaging session of the same neuronal populations (Fig.1j,k). Both stimuli C and D evoked strong prediction-error responses when they were unexpected (Fig.1land Extended Data Fig.2c,d). Neural responses to C and D should be similar if they simply represented a non-specific surprise signal, or activity related to surprise-triggered movement, such as deceleration in response to an unexpected stimulus. However, most neurons responded strongly to only one of the two unexpected stimuli, and V1 population responses to these stimuli were thus different and specific to stimulus features (Fig.1m,nand Extended Data Fig.5a–e). This was also the case when comparing prediction-error responses to two more similar visual stimuli (two gratings of different orientation; Extended Data Fig.5l–p).

*** Indeed, V1 neurons that responded to an unexpected stimulus (that is, grating C) often also responded to the same stimulus when it was expected, but not to gratings A or B (Fig.2a–c). Importantly, only visually driven neurons that responded highly selectively to a stimulus showed amplified responses when this stimulus was unexpected (Fig.2d–f;P= 0.0078 for highly selective cells), whereas more broadly tuned neurons that also responded to other visual stimuli did not show prediction-error signals (Fig.2e,f:P= 0.82 for non-selective cells). This selective amplification was equally evident in the V1 responses to a different unexpected stimulus (stimulus D; Extended Data Fig.6a–h), and could not be explained by differences in response strength between selective and non-selective neurons (Extended Data Fig.6i,j). Notably, increased V1 activity in response to a familiar stimulus (A) at an unexpected location was also restricted to those visually responsive neurons selective for the presented stimulus (Extended Data Fig.4e,f), indicating that selective amplification of visual information that is unexpected may be a general feature of sensory prediction-error signals in V1.

*** a, Trial-averaged responses of all prediction-error-responsive neurons (n= 329 cells, 9 mice) to all grating stimuli in traversals with unexpected C4 (top; block 1) and expected C4 (bottom; late block 2), sorted by response to unexpected C4.b, Same asa, but average response strength of individual neurons (top) and mean calcium responses of all neurons (bottom). Shading indicates bootstrap 95% confidence intervals.c, Difference in response strength to unexpected (block 1) and expected C4 (late block 2) for all grating-responsive cells in late block 2, plotted against response to expected C4 in late block 2 for individual neurons. Pearson correlation; 9 mice.d, Left, difference in response strength between unexpected and expected C4 responses of individual neurons, plotted against their response selectivity to stimulus C versus stimulus B in late block 2 (Methods) for all neurons responsive to at least one of the grating stimuli in late block 2. −1 indicates only responsive to B, +1 indicates only responsive to C, and 0 indicates similar responses to both. Right, same as on the left but for response selectivity to stimulus C versus stimulus A.e, Mean responses to expected (blue) and unexpected (red) C4, of V1 neurons responsive to A or B (left), of non-selective (middle; responsive to C with selectivity < 0.6) and highly selective neurons (right; responsive to C with selectivity towards C, compared to B > 0.8) in late block 2. Data are mean responses for individual mice (n= 9), black horizontal bars indicate mean across mice. Two-sided signed-rank test.f, Mean calcium responses to stimulus C4 across all trials of highly selective (dark grey,n= 77 cells from 9 mice) and non-selective (light grey,n= 53) grating C4-responsive cells in late block 2. Error bars indicate bootstrap 95% confidence intervals. See also Extended Data Figs.4–6.

*** Source Data

*** In addition to visually driven neurons, a subset of non-visually responsive neurons was also recruited by prediction errors (Fig.2aand Extended Data Fig.4i). Responses of these neurons were nevertheless highly stimulus-selective, and restricted to specific unexpected stimuli (Extended Data Fig.5f–k). Neurons responding to the unexpected omission of a stimulus constituted an additional V1 population, which was not activated when the omitted stimulus was instead replaced by a different, unexpected stimulus (Extended Data Fig.5q–z). This indicates that negative prediction errors (responses to the unexpected absence of a stimulus or event10,14) are not significantly contributing to the V1 prediction-error signal in response to a novel, unexpected stimulus.

*** Together, these experiments indicate that the prediction-error signal evoked in layer 2/3 of V1 by unexpected visual stimuli is not a non-specific surprise or a difference signal about how the visual input deviates from the animal’s predictions. Instead, prediction error signals are specific to the features of the unexpected visual input and amplify the activity of neurons that respond highly selectively to the unexpected visual features, thereby selectively increasing the salience of unpredicted—and therefore potentially most relevant—sensory information.

*** We next examined the circuit mechanisms by which sensory prediction error signals are implemented in V1 networks. VIP inhibitory interneurons in V1 receive cortical top-down and neuromodulatory inputs, and can disinhibit local principal cells through prominent inhibitory connections onto somatostatin-expressing (SOM) inhibitory interneurons24,25,26,27,28, providing a circuit for top-down gain modulation of sensory responses29,30. VIP cells have also been shown to respond strongly to novel, but not familiar, visual stimuli20,23. To assess whether VIP interneuron activity is important for prediction-error signals in V1, we first examined how VIP interneurons respond to unexpected and expected visual information by using the experimental paradigms described in Fig.1k(Fig.3a). VIP interneurons were suppressed by expected visual stimuli, but strongly responded to unexpected visual stimuli (Fig.3b–dand Extended Data Fig.7a,b), consistent with previous studies15,20,23. VIP neurons also responded to familiar stimuli encountered at an unexpected location (Extended Data Fig.8a–d), showing that they are not only activated by novel stimuli, but also by sensory prediction errors more generally. Prediction-error responses of VIP neurons were much less selective than those of putative excitatory neurons in V1: many VIP neurons responded to both unexpected stimuli C and D (Extended Data Fig.7c–e). Responses of VIP interneurons decreased over time as mice encountered the same stimulus more often, in parallel with the gradual cessation of the prediction-error signal in the layer 2/3 network (Fig.3d; see also Fig.1d), suggesting that the recruitment of VIP interneurons may be causally related to the generation of prediction-error signals in V1.

*** a, Experimental design. Calcium activity of VIP cells in V1 layer 2/3 was recorded during the experiment depicted in Fig.1k.b, Single-cell responses for all VIP cells (individual rows) in the session with unexpected stimulus C (top; C session,n= 350 cells from 7 mice) and with unexpected stimulus D (bottom; D session,n= 403 cells from 7 mice) to expected B4 (left), unexpected C4 or D4 (middle; block 1) and expected C4 or D4 (right; late block 2), sorted by response strength to unexpected C4 or D4.c, Cell- and trial-averaged stimulus responses of all VIP cells inb.Pvalues from hierarchical bootstrapping test with Bonferroni correction.d, Average calcium responses of all VIP cells to grating stimulus C4 or D4 (dark grey) and other gratings in the same trial (average of A1, B2 and A3, light grey) over time.e, Experimental design. Calcium activity of V1 layer 2/3 cells was recorded while VIP cells were optogenetically silenced during visual stimulus presentation.f, Top, cell- and trial-averaged responses of V1 neurons significantly responsive to the presented visual stimuli with (amber) or without (black) VIP silencing. Bottom, responses of individual neurons to the visual stimulus indicated above during VIP cell silencing (LED on), plotted against responses to the same stimulus in control trials (LED off).Pvalues from hierarchical bootstrapping test, from 9 mice.g, Effect of VIP neuron silencing (LED on − LED off during unexpected stimulus C4 or D4) plotted against the strength of prediction-error signals (response to unexpected C4 or D4 − response to expected C4 or D4); Pearson correlation.h–k, Same asa–d, but for calcium responses of pulvinar axonal boutons in V1 layer 1.l–n, Same ase–g, but the activity of V1 layer 2/3 cells was recorded while pulvinar axons in V1 were optogenetically silenced.c,d,f,j,k,m, Data are mean ± bootstrap 95% confidence intervals (shading or error bars). See also Extended Data Figs.7–10.

*** Source Data

*** To test whether the recruitment of VIP interneurons is required for the prediction-error signal in the general V1 population, we optogenetically silenced VIP interneurons as mice encountered expected or unexpected visual stimuli while recording calcium responses of V1 layer 2/3 neurons (Fig.3e–gandMethods). This manipulation was highly effective as VIP neurons were fully inactivated during light stimulation (Extended Data Fig.9a–c). Inactivating VIP neurons significantly reduced the responses of V1 layer 2/3 cells to unexpected visual stimuli (Fig.3f, middle,P< 1 × 10−4; Extended Data Fig.10a–h), whereas it had no effect on responses to expected visual stimuli A and B (Fig.3f, left;P= 0.24), consistent with the specific recruitment of VIP interneurons by unexpected sensory stimuli (Fig.3a–d). Furthermore, the effect of VIP inactivation on individual V1 layer 2/3 cells could not be explained by light artefacts (Extended Data Fig.9g,h), and it was not uniform, but highly correlated with how strongly V1 neurons were facilitated by prediction errors, much more so than with their visual response strength: neurons with the strongest prediction-error signal were the ones that were most suppressed by VIP interneuron inactivation (Fig.3gand Extended Data Fig.10c,e,f). V1 prediction-error signals in response to familiar stimulus A at an unexpected location were also abolished when VIP neurons were inactivated (Extended Data Fig.8e,f), demonstrating that the recruitment of VIP neurons is required more generally for prediction-error signals in layer 2/3 of V1, rather than specifically for V1 signals related to stimulus novelty.

*** We next explored the identity of the long-range inputs to V1 that could mediate the activation of VIP neurons by prediction errors. The pulvinar is a higher-order visual area in thalamus, also called lateral posterior nucleus in mice, that integrates information from many cortical and subcortical areas and sends prominent feedback projections to V131,32,33,34,35,36. Notably, pulvinar projections to V1 carry information about visual input that is not predicted by the animal’s own actions, indicating that the pulvinar conveys sensory–motor prediction errors to V131. To test whether pulvinar projections to V1 also signal prediction errors arising from spatial predictions of visual input in our task, we used two-photon imaging to record calcium signals from pulvinar axons in V131. Calcium activity of pulvinar axons was strongly and non-selectively boosted when a visual stimulus was unexpected (Fig.3h–kand Extended Data Fig.7h–n), and this prediction-error response decreased with repeated exposure to the same stimulus, with a time course similar to responses in V1 neurons (Fig.3k). Pulvinar axons were also activated by a familiar stimulus at an unexpected location (Extended Data Fig.8g–i).

*** To determine whether pulvinar input to V1 is required for prediction-error signals in V1 neurons, we optogenetically inactivated pulvinar axons in V1 while recording calcium responses of V1 layer 2/3 neurons (Fig.3l–n). This manipulation—light stimulation of eNpHR3.0-expressing pulvinar axons in V1—reduced activity of pulvinar axons, but had only a partial effect (Extended Data Fig.9d–f). Nevertheless, suppressing pulvinar input to V1 specifically reduced the responses of V1 layer 2/3 neurons to unexpected visual stimuli (Fig.3m, middle,P< 1 × 10−4, and Extended Data Fig.10i–p), but not to expected stimuli (Fig.3m,P= 0.074 andP= 0.088 for visual stimuli A and B, and expected C and D, respectively). Similar to the effect of VIP neuron silencing, V1 neurons with strong prediction-error responses were more likely to be strongly suppressed by pulvinar inactivation (Fig.3nand Extended Data Fig.10k,m), independent of their visual response strength (Extended Data Fig.10n). Moreover, pulvinar input was also required for V1 prediction-error responses to a familiar stimulus at an unexpected location (Extended Data Fig.8j,k). Together, these cell-type-specific inactivation experiments indicate that both intracortical VIP interneurons and pulvinar inputs contribute to prediction-error signals in V1. Next, we investigated how these two circuit elements interact to generate the amplified responses to unexpected stimuli.

*** Pulvinar axons make synaptic connections onto VIP neurons in the neocortex30. A plausible scenario for how the pulvinar and neocortical VIP neurons interact to mediate prediction-error signals may therefore involve pulvinar input activating VIP neurons in V1, which in turn boost pyramidal neuron responses to unexpected visual stimuli through the VIP–SOM disinhibitory circuit24,25,26,28. To directly test this hypothesis, we optogenetically stimulated either pulvinar axons or VIP interneurons in V1 while monitoring neural responses of V1 layer 2/3 neurons to the expected grating stimuli in the virtual corridor (Fig.4a–c; see also Extended Data Fig.11). Consistent with a previous report37, stimulating pulvinar axons broadly suppressed responses to visual stimuli in V1 (Fig.4b,P= 2.0 × 10−4). Moreover, stimulating pulvinar axons excited only a small subset of VIP neurons, and decreased VIP neuron prediction-error responses (Extended Data Fig.12a–f). Optogenetically stimulating VIP interneurons had a minor effect on V1 activity, with a non-significant trend towards facilitating visual responses, unlike the strong amplification of stimulus-selective V1 neurons by prediction errors (Fig.4c;P= 0.18). Remarkably, simultaneous co-activation of both pulvinar axons and VIP neurons strongly facilitated visual responses of a subset of V1 neurons (Fig.4d,P= 0.020), indicating that pulvinar input and VIP neurons act synergistically, not additively. Moreover, response facilitation was specific to those visually driven neurons that responded highly selectively to the visual stimulus that was paired with optogenetic stimulation, mimicking the prediction-error signal in V1 (Fig.4d,P= 0.039; Extended Data Fig.11f–i; compared to Fig.2d,e). Our experimental evidence therefore does not support a direct pathway from pulvinar inputs onto VIP neurons to facilitate V1 responses, but pulvinar and VIP neurons are likely to be recruited independently, and act synergistically to provide stimulus-selective amplification of responses to unexpected stimuli in V1.

*** a, Experimental design. After training in the virtual corridor (stimuli A–B–A–B), optogenetic manipulation was paired with grating B2 in 50% of trials.b, Left, the activity of V1 layer 2/3 cells was recorded while pulvinar axons were optogenetically stimulated. Stimulation started 0.1 s after grating onset and lasted for 1 s. Second column, responses of individual V1 neurons with and without pulvinar axonal stimulation (LED on versus LED off).n= 118 grating A or B responsive cells from 6 mice, Hierarchical bootstrapping test. Inset, cell-averaged calcium responses with (amber) or without (black) optogenetic stimulation. Lines and shaded regions are mean and bootstrap 95% confidence intervals. Third column, effect of optogenetic stimulation (difference of response to grating B2 with and without LED stimulation) plotted against response selectivity (Methods) of individual V1 neurons. Right, calcium response strength to stimulus B2 of neurons selective to A (left), and non-selective (selectivity B versus A < 0.6, middle) and highly selective (selectivity B versus A > 0.8, right) grating B2 responsive cells in V1 layer 2/3 with (amber) or without (grey) optogenetic stimulation.Pvalues from two-sided signed-rank test. Data points depict mean responses for individual imaging sessions;n= 6 mice; black horizontal bars indicate mean across animals.c, Same asb, but the activity of V1 layer 2/3 cells was recorded while VIP cells were optogenetically stimulated.n= 6 mice.d, Same asb, but the activity of V1 layer 2/3 cells was recorded while pulvinar axons and VIP cells were optogenetically stimulated simultaneously.n= 9 mice.e, Same asb, but the activity of V1 layer 2/3 cells was recorded while pulvinar axons and SOM cells were optogenetically co-manipulated for 3 s starting at grating stimulus onset.n= 6 sessions from 4 mice. See also Extended Data Fig.11.

*** Source Data

*** Our results indicate that when VIP neurons are activated, they can counteract the inhibitory influence pulvinar activation has on the V1 network. The main synaptic targets of VIP neurons are SOM interneurons that inhibit the apical dendrites of pyramidal cells24,25,26,28. VIP neurons can therefore disinhibit pyramidal cells via the inhibition of SOM neurons. We hypothesized that pulvinar activation may recruit SOM neurons whose inhibitory influence on the V1 network may be alleviated when VIP neurons are simultaneously active. If this were the case, silencing SOM neurons while activating pulvinar should have effects similar to VIP neuron and pulvinar co-activation. Indeed, simultaneous optogenetic stimulation of pulvinar axons and inactivation of SOM neurons in V1 completely abolished the pulvinar-driven suppression of V1 activity (Fig.4e; compared to Fig.4b). Remarkably, this manipulation also strongly and specifically facilitated visual responses of V1 neurons responding highly selectively to the visual stimulus paired with the optogenetic manipulation, again mimicking the V1 prediction-error signal (Fig.4e,P= 0.031), and suggesting that the pulvinar’s excitatory drive onto V1 pyramidal neurons is accompanied by a strong feed-forward inhibitory drive via SOM neurons.

*** Although higher-order sensory thalamocortical pathways do not prominently target cortical SOM neurons37,38,39, at least a subset of SOM neurons in V1 has been shown to receive input from the pulvinar30,40,41. We imaged responses of V1 layer 2/3 SOM neurons while optogenetically stimulating pulvinar axons in V1, and found that although most SOM neurons were either not affected or even suppressed, a subset of SOM neurons (16 ± 9%; mean ± s.d.) was strongly activated by pulvinar stimulation (Fig.5a–cand Extended Data Fig.12g,h). Notably, SOM neurons that were recruited by pulvinar stimulation were suppressed by unexpected visual input, suggesting that this subset of SOM neurons is inhibited by VIP neurons28(Fig.5d,e). By contrast, layer 2/3 SOM neurons that are not recruited by pulvinar stimulation were activated by unexpected visual stimuli, similar to VIP neurons, suggesting that they do not receive strong inhibition from VIP neurons and/or are more strongly driven by the local excitatory layer 2/3 network (Fig.5d,e), consistent with previous studies28,42,43. Together, these results show that excitatory drive from the pulvinar onto V1 pyramidal neurons is paralleled by a powerful inhibitory pathway via a specific subpopulation of SOM neurons. When VIP neurons are active simultaneously with pulvinar input they inhibit SOM neurons, thus reducing feed-forward inhibition from pulvinar to V1, and enabling pulvinar drive to strongly activate a subset of layer 2/3 pyramidal cells (Fig.5f). These results therefore reveal a circuit driving V1 prediction-error signals through synergistic interactions of pulvinar inputs and VIP neurons.

*** a, Experimental design. The activity of SOM cells was recorded while pulvinar axons were optogenetically stimulated for 3 s starting at visual stimulus onset.b, Single-cell responses to expected and unexpected visual stimuli of all SOM cells (individual rows,n= 6 sessions from 4 mice) with (right) or without (left) optogenetic stimulation.c, Cell-averaged calcium responses with (amber) or without (black) optogenetic stimulation of SOM cells significantly activated by pulvinar stimulation (recruited cells,n= 29) and other cells (n= 159). Lines represent the mean and shaded regions indicate 95% confidence intervals.d, Visual stimulus responses of individual SOM neurons to expected B4 stimulus (left), unexpected C4 or D4 stimulus (middle; in block 1) and expected C4 or D4 stimulus (right; in late block 2) plotted against the effect of pulvinar stimulation (difference in strength of visual stimulus responses with and without optogenetic pulvinar axon stimulation) for recruited (brown) and other (black) SOM cells.e, Cell-averaged strength of calcium response to expected B4 (black), unexpected C4 or D4 (red) and expected C4 or D4 (blue) stimuli of recruited and other SOM cells.Pvalues from hierarchical bootstrapping test with Bonferroni correction. Data are mean ± 95% bootstrap confidence intervals.f, Proposed circuit mechanism for sensory prediction errors. VIP neurons inhibit a specific subpopulation of SOM cells that otherwise gate pulvinar input to V1, resulting in specific pulvinar-driven response amplification of the most stimulus-selective neurons in V1. See also Extended Data Fig.12.

*** Source Data

*** Here we describe a mechanism for boosting sensory responses by prediction errors in V1 when animals’ expectations of visual stimuli at specific locations of a virtual environment are violated. Prediction errors selectively amplify the representation of unexpected visual input, via synergistic interactions of higher-order thalamic input and local VIP–SOM disinhibitory circuits in V1.

*** Prediction-error responses are dependent on VIP neuron activity as well as input from the pulvinar, a higher-order visual nucleus in the thalamus that has previously been implicated in predictive processing, and conveys prediction-error signals to V131,32,44. Co-activation of pulvinar axons and VIP neurons in V1 can reproduce the selective amplification of V1 neurons even in the absence of prediction errors. Notably, we found that pulvinar input to V1 is gated by VIP–SOM inhibitory interactions. The pulvinar suppresses the activity of V1 cells via a subpopulation of SOM neurons. To allow pulvinar input to amplify V1 responses, this inhibition has to be alleviated by activity in VIP neurons that inhibit SOM neuron responses (Fig.5f). This mechanism may explain seemingly contradictory findings about how the pulvinar affects cortical activity37,45and establishes VIP neurons as a gate for higher-order thalamic input to V1. VIP neurons receive prominent neuromodulatory and top-down cortical input, and have been shown to be activated by salient events such as reward, punishment and novel stimuli20,23,24,26,27,29,30,46,47,48. They can therefore regulate the influence of pulvinar input on visual processing in V1, depending on the relevance of visual stimuli or the animal’s behavioural state. As VIP–SOM disinhibitory circuits and higher-order thalamic feedback input are present throughout the cortical hierarchy24,25,26,28,30,34,47, this cooperative circuit mechanism may serve as a common computational motif in neocortical networks.

*** Although VIP neurons and pulvinar inputs to V1 are broadly recruited by unexpected stimuli (Extended Data Fig.7), prediction-error signals in V1 are observed only in subpopulations of neurons that are highly selective for the visual stimulus encountered. Our results point to a potential circuit mechanism for this selective response amplification in V1. We reproduced the selective amplification of only stimulus-selective V1 neurons by co-activating VIP neurons with pulvinar input to V1, but also when bypassing VIP activation by silencing SOM neurons while stimulating pulvinar input (Fig.4d,e). Thus, selectivity of response amplification in V1 neurons does not depend on VIP neuron recruitment or the activity of SOM neurons, but rather on pulvinar input more effectively driving V1 neurons with sharp tuning. This suggests a selective influence of pulvinar on subpopulations of stimulus-selective V1 neurons, balanced by inhibition from pulvinar-driven SOM neurons (Extended Data Fig.11j–m). This pulvinar-dependent response enhancement may be further amplified via recurrent excitation within subnetworks of selective V1 neurons tuned to the same stimulus49and lateral suppression of the rest of the network via parvalbumin-expressing neurons50,51,52, collectively leading to selective amplification of unexpected input.

*** Which inputs drive pulvinar and VIP neurons, and what information do they convey? Visual prediction errors are derived through a comparison of the actual visual input with internal predictions of expected visual input. Several top-down pathways have been proposed to convey different types of stimulus predictions to V1, including higher visual areas and anterior cingulate cortex6,14,53. In our paradigm, prediction errors may arise from violations of spatial predictions of the expected visual scene at a given location. Such spatio-visual predictions necessitate neural representations of space and spatial memory, and are thus likely to originate from hippocampus or related areas such as the retrosplenial cortex54,55. Previous studies have proposed that visual prediction errors may be computed in V16,14,53. We observed sensory prediction-error signals not only in V1, but also in the pulvinar, and V1 prediction errors were dependent on pulvinar input. Prediction-error signals may therefore be computed outside of these visual areas—for instance, within the hippocampal formation—and conveyed to V1 by top-down projections via pulvinar and local VIP interneurons. Alternatively, errors could be computed in the pulvinar or in V1 from the comparison of visual input with spatio-visual predictions5,6,7,8,9,10,14, and could then be amplified through pulvinar–V1 recurrent connections. The generation of other types of visual prediction errors observed in V1, such as those signalling deviations from visuo-motor predictions given the animal’s own actions15,31, probably involves different, motor-related pathways, including superior colliculus, anterior cingulate cortex or secondary motor cortex10,53,56,57. In general, prediction-error signals in V1 may be further enhanced by neuromodulators such as acetylcholine or noradrenaline that may signal stimulus saliency and novelty, or surprise more generally27,48,58,59, and these signals are likely to influence the activity of VIP neurons27,48,60.

*** Our results indicate that individual V1 neurons do not signal how the actual visual input deviates from the animal’s predictions, as postulated within the predictive coding framework5,6,7,8. Instead, we propose an alternative view of predictive processing in sensory circuits: prediction errors amplify the representation of feed-forward sensory input in neocortex, while the extent of amplification may depend on how much the visual stimulus deviates from expectations and therefore the magnitude of animals’ surprise. This would explain the particularly strong responses to novel stimuli that were not encountered before, as these are the least expected20,23. The amplified responses to unexpected stimuli may serve as a neural substrate for attentional shifts towards surprising events in the environment. However, the content of how actual input deviates from predictions may still be encoded in other brain areas or higher-dimensional population activity in V1.

*** In summary, sensory prediction errors in V1 increase the saliency of unexpected, and thus probably relevant, visual information. This enables downstream brain areas to prioritize these signals and potentially utilize them for updating internal predictions.

*** All experiments were performed under the UK Animals (Scientific Procedures) Act of 1986 (PPL PD867676F) following UK Home Office approval and local ethical approval by the Sainsbury Wellcome Centre Animal Welfare Ethical Review Body. A total of 105 mice, including 27 C57BL/6J mice, 24 VIP-Cre mice (JAX 010908, Jackson Laboratory; Cre expressed in VIP interneurons), 43 VIP-Cre × Ai14 mice (JAX 010908 and JAX 007914, Jackson Laboratory; tdTomato expressed in VIP interneurons), 7 SOM-Cre mice (JAX 013044, Jackson Laboratory; Cre expressed in SOM interneurons) and 4 SOM-Cre × Ai14 mice (JAX 013044 and JAX 007914, Jackson Laboratory; tdTomato expressed in SOM interneurons) were used in this study. Both female and male mice, at least 7 weeks old at the start of the experiments, were used. Mice were co-housed with littermates in IVC cages, in reversed day–night cycle lighting conditions, with the ambient temperature and humidity set to 23 °C and 56% relative humidity, respectively. Standard environment enrichment was provided in the form of a running wheel, a clear tube and wooden toys.

*** Prior to surgery, Dexadreson (2–3 mg kg−1) and Carprofen (5 mg kg−1) were administered. General anaesthesia was induced with 2.5–3% isoflurane, which was then reduced to maintain a breathing rate of around 1 Hz. A 3- or 4-mm craniotomy was made over the right V1, centred on 2.45 mm lateral and 3.6 mm posterior of bregma. For two-photon calcium imaging and optogenetic manipulations of V1 cells, we injected adeno-associated virus (AAV) vectors into right monocular V1 (centred on 2.45 mm lateral and 3.7 mm posterior of bregma, 1–3 injections per mouse, 100–150 nl per injection). For two-photon calcium imaging and optogenetic manipulations of pulvinar axons, we injected AAV vector into the right pulvinar (calcium imaging and optogenetic activation: 1.6 mm lateral and 2.1 mm posterior of bregma, 2.35 below the cortical surface, 1 injection per mouse, 60 nl per injection; optogenetic inactivation: 1.55 mm lateral and 2.0 mm posterior of bregma, 2.3 mm below the cortical surface, 1.60 mm lateral and 2.2 mm posterior of bregma, 2.4 mm below the cortical surface, 2 injections per mouse, 60 nl per injection). All injections were performed using glass pipettes and Nanoject III microinjector (Drummond Scientific) or a pressure injection system (Picospritzer III, Parker). A 3- or 4-mm circular cover glass was glued in place using cyanoacrylate glue (Pattex). A custom-designed stainless steel head plate was attached to the skull using dental cement (Super-Bond C&B, Sun Medical). Animals were given analgesics (Carprofen; 5 mg kg−1) at 24 and 48 h after surgery. Imaging started approximately 3 weeks after the virus injection.

*** We used AAV1-hSyn-GCaMP6f (2 × 1013vg ml−1Penn Vector Core/Addgene; diluted 1:8 to 1:15 in saline) for experiments involving two-photon calcium imaging of V1 layer 2/3 cells; AAV1-hSyn-GCaMP7b (2 × 1013vg ml−1Penn Vector Core/Addgene; diluted 1:2 in saline) or AAV1-hSyn-axon-GcaMP6s (9 × 1012vg ml−1Penn Vector Core/Addgene; diluted 1:2 in saline) for imaging of pulvinar axons; AAV2-EF1a-DIO-eNpHR3.0-mCherry (4.0 × 1012vg ml−1, 1:2 to 1:10 dilution, UNC vector core) for optogenetic silencing of VIP cells or SOM cells; AAV2-hSyn-eNpHR3.0-mCherry (3.3 × 1012vg ml−1, 1:2 to 1:4 dilution, UNC vector core) for optogenetic silencing of pulvinar axons; AAV1-hSyn-Flex-ChrimsonR-tdTomato (3.9 × 1012vg ml−1, 1:2 to 1:5 dilution, UNC vector core) for optogenetic activation of VIP cells; AAV1-Syn-ChrimsonR-tdTomato (4.1 × 1012vg ml−1, 1:2 to 1:5 dilution, UNC vector core) for optogenetic activation of pulvinar inputs; AAV1-hEF1a-mCherry (5.7 × 1012vg ml−1, 1:2 to 1:5 dilution, Zurich vector core) for control experiment for LED light stimulation.

*** Behavioural setups consisted of a styrofoam running wheel, two visual stimulation display monitors (see below), a reward delivery spout, and a camera for recording the pupil. Mice were head-fixed and placed on a styrofoam wheel (20 cm diameter, 12 cm width). Their running speed was monitored using a rotary encoder (Kubler Encoder 1000 ppr) coupled to the wheel axle. Reward (a drop of strawberry milk, 50% Ensure nutrition shake, Abbott Laboratories) was delivered by a lick spout in front of the mouse and was regulated via a solenoid pinch valve (161P011, NResearch). Licks were detected with a piezoelectric diaphragm sensor (7BB-12-9, Murata) placed under the spout. Images of the left eye were recorded with a CMOS camera (22BUC03, Imaging Source) at 30 Hz in order to track eye movements and pupil size. The recording of the encoder, presentation of visual stimuli, opening of the reward valves, and camera recordings were controlled by custom-written software in LabView. Behavioural data were acquired using a PCIe 6321 acquisition card (National Instruments).

*** Before mice underwent training in the virtual environment, they were food-restricted and pre-trained to encourage continuous running on the styrofoam wheel. Four to seven days after surgery, food restriction and pre-training started. Mice were weighed daily and given typically 2–3 g of food pellet in addition to strawberry milk given in training sessions to ensure they maintained around 90%, but at least 85%, of their starting body weight. For the first few days, animals were handled in a soft cloth and iteratively fed strawberry milk (Abbott Laboratories) through a syringe until they got used to short manual restraint of the head plate. Mice were then head-fixed and put on the freely rotating styrofoam wheel for 15–60 min. Mice were encouraged to run on the wheel by delivering strawberry milk rewards after they moved a short distance (initially set to ~10 cm). This distance was adjusted (up to 500 cm) depending on the running speed of the mouse, such that mice received roughly one reward every 30 s. Additional rewards were occasionally delivered by the experimenter. This pre-training took 4–10 days.

*** Once mice were running continuously, they were moved to a virtual environment consisting of a linear corridor with varying wall patterns as described previously14. The cylinder’s rotation (the instantaneous running speed of the animal) was used to control the speed at which the animal moved through the virtual environment. The virtual environment was displayed on two monitors (U2715H, Dell; 60 Hz refresh rate), placed 21 cm away from both eyes of mice and oriented at 35° relative to the midline. Each monitor covered a visual field of approximately 110° horizontally and 60° vertically. All elements of the corridor including the gratings were calibrated to be isoluminant (10.1 cd m−2). The luminance of the monitor was set at 0.1 cd m−2, 10.1 cd m−2and 20.1 cd m−2, at black, grey and white values, respectively. The luminance of visual stimuli was measured using a luminance meter (Konica Minolta, LS-100). The grey walls of the virtual corridor were lined with four different landmarks. The last landmark represented the reward zone located at the end of the corridor. Reaching the reward zone triggered an automatic reward delivered by a spout located in front of the mouse. After the reward delivery, the virtual environment was reset to the beginning of the corridor to start the next trial.

*** Grating stimuli were suddenly presented on full screen once the mouse entered a certain position in the corridor. This was done to ensure precise control of when the mouse would first see the grating. Grating stimuli were presented at four different positions between landmarks. The optic flow of the grating stimuli was ‘uncoupled’ from the running speed for 2.4 s, such that the animal’s locomotion did not affect its temporal frequency. Gratings were square-wave gratings, with the spatial frequency of approximately 0.04 cycles per degree (cpd) at the centre of the monitor and the temporal frequency approximately 2 cycles per second (Hz). Duration of the grating presentation was approximately 2 s at the centre of the monitors. The precise timing of visual stimulus onsets was recorded with a photodiode (Thorlabs) attached to the monitor.

*** During 5 training sessions, the virtual corridor and the sequence of the four grating stimuli was identical (A–B–A–B) on every trial. In the subsequent imaging session, the identity of one of the four grating stimuli was changed. In block 1 of this session (160 trials), the identity of the 4th grating stimulus B changed either to a novel grating stimulus C (C session), a novel stimulus D (D session), familiar stimulus A (A session) or no stimulus was shown (omission session) on randomly chosen 10% of trials. In block 2, the novel stimulus or no stimulus was shown at the fourth position in 100% of trials. Occasionally one mouse underwent several sessions with unexpected stimuli. In that case, mice went through another training session (with gratings A–B–A–B) in between. For imaging of pulvinar axons, block 1 was shortened to 60 trials, and either a novel grating stimulus C (C session) or a novel stimulus D (D session) was shown at the fourth position on randomly chosen 15% of trials. In block 2, the novel stimulus was shown in 100% of trials, as for imaging of V1 layer 2/3 cells. For experiments in Extended Data Figs.3a–eand5l–p, a horizontal grating stimulus E was shown at position 1 and 3 instead of grating stimulus A (E–B–E–B). A novel stimulus C (C session) or a novel stimulus A (A session) was shown on randomly chosen 10% of trials. For experiments in Extended Data Figs.8and9a–c, we used a short version of the virtual corridor with two grating stimuli (A–B) and the identity of the 2nd grating stimulus B changed to familiar stimulus A on randomly chosen 10% of trials.

*** For experiments in Extended Data Fig.9d–f, visual stimuli were generated using the open-source Psychophysics Toolbox61based on MATLAB (MathWorks) and were presented full-field on one monitor at approximately 21 cm from the left eye of the mouse, covering 110° of visual space. Square-wave gratings (spatial frequency: 0.04 cpd, temporal frequency: 2 Hz, duration: 2 s, interval: 4 s, directions: 0 to 360° in 45° increments) were randomized in order and presented 10 times per direction.

*** Two-photon calcium imaging was performed using a commercial resonance scanning two-photon microscope (B-Scope; Thorlabs) with a 16× water-immersion objective (NA 0.8, Nikon), with a Ti::Sapphire laser at 930 nm excitation wavelength (Mai Tai, SpectraPhysics). Emission light was band-pass filtered using a 525/50 filter for GCaMP and a 607/70 filter for tdTomato/mCherry (Semrock). Images of 512 × 512 pixels from four imaging planes with fields of view ranging from 380 × 380 μm to 440 × 440 μm were acquired at 7.5 Hz frame rate for imaging of V1 neurons and of a single plane of 160 × 160 μm at 15 Hz frame rate for imaging of pulvinar axonal boutons using ScanImage62. For imaging of V1 neurons, we used a piezo-actuator (Physik Instrumente) to move the objective in steps of 15 μm between frames to acquire images at four different depths, thus reducing the effective frame rate to 7.5 Hz. Imaging of V1 neurons was performed in layer 2/3 (typically 150–200 μm below the cortical surface). The laser power under the objective never exceeded 35 mW. Axonal bouton calcium measurements were performed in cortical layer 1 (35–55 μm below the cortical surface), with laser powers below 20 mW.

*** To avoid cross-talk between imaging and visual stimulation, the monitor backlight was controlled using a custom-built circuit to present visual stimuli only at the resonant scanner turnaround points in between two subsequent imaging lines (when data were not acquired)63. The frame trigger signal during two-photon calcium imaging was recorded by Labview and used for synchronization between the calcium imaging frames and task related data (for example, behaviour data and visual stimuli onsets).

*** For imaging of pulvinar axons, we used VIP-Cre × Ai14 mice. We simultaneously imaged pulvinar axons expressing GCaMP and neurites of VIP neurons expressing tdTomato in layer 1. We then used the red signal (tdTomato) as a structural marker to perform Z-drift correction during imaging and frame registration during data pre-processing.

*** Simultaneous two-photon imaging and optogenetic stimulations were performed as previously described15. Briefly, 595 nm light was delivered through the objective lens using a fast LED (UHP-T-595, Prizmatix). The LED light power was set to 8 mW in front of the objective. To combine two-photon imaging and optogenetic manipulation, the LED for optogenetic manipulation was synchronized to the resonant scanner turnaround points (when data were not acquired). The propagation of reflected light to the eyes of the mouse was blocked by a metal light shield cone placed on the head plate and a black cement wall around the implant. Optogenetic manipulation occurred in randomly chosen 10–50% of each trial type. For most of optogenetic manipulations, LED stimulation was applied continuously for 3 s, starting at visual stimulus onset. For optogenetic silencing during passive visual stimulation (Extended Data Fig.9d–f), LED stimulation was applied throughout visual stimulus presentation (2 s). For optogenetic activation (Fig.4b–dand Extended Data Fig.11a–c,f–i), LED stimulation was applied at a frequency of 20 Hz, with 40% duty cycle (20 ms pulses) for 1 s starting 0.1 s after visual stimulus onset.

*** At the end of each experiment, targeting of virus injections was confirmed by histology. Brains were extracted and fixed overnight in 4% paraformaldehyde, and stored in a 50 mM phosphate buffer. Brains were embedded in 5% agarose and imaged using serial section64two-photon65microscopy. Our microscope was controlled by ScanImage Basic (MBF Bioscience) using BakingTray, a custom software wrapper for setting up the imaging parameters66. Images were assembled using StitchIt67. Coronal slices were cut at a thickness of 40 μm using a vibratome (Leica VT1000), and imaged every 20 µm with a 16× water-immersion objective (NA 0.8, Nikon). Whole brain coronal image stacks were acquired at a resolution of 4.4 × 4.4 × 20 µm inxyz, with a two-photon laser wavelength of 780 nm, and approximately 130 mW at the sample. Selected brain images were registered to the adult mouse Allen common coordinate framework68using The Slice Histology Alignment, Registration, and Probe-Track analysis (SHARP-Track), a MATLAB based registration pipeline with optimized parameters for mouse brain registration at various cutting angles69. A subset of brains was embedded in 4% agarose (A9539, Sigma), cut in 200 μm coronal slices on a vibratome (HM650V; Microm), mounted in a mounting medium containing DAPI (Vectashield; Vector Laboratories) and imaged on a slide scanner (Zeiss AxioScan) or on a confocal microscope (Leica SP8).

*** Two-photon imaging frames were motion corrected and segmented using custom-written scripts in MATLAB as previously described31. In brief, to correct forx–ymotion, two-photon imaging frames were registered to a 1,200-frame average (40 frames × 30 batches) using a phase-correlation algorithm. When the same V1 neurons were imaged over multiple sessions, images from those sessions were registered together, and identical cells were matched across sessions by using custom-written software. Frames with large motion were detected by inspecting the registration displacement results and were discarded from further analysis. Regions of interest (ROIs) were detected semi-automatically using intensity thresholding combined with principal component analysis–independent component analysis refinement and validated and refined manually. All time series were extracted and analysed with custom-written functions using the TimeSeriesAnalysis package70. All pixels within each ROI were averaged to give a single time course. Contaminating signals from neuropil were subtracted using an asymmetric Student’stmodel (ast_model;https://github.com/BaselLaserMouse/ast_model). Calcium ΔF/F0signals were obtained by using the baseline fluorescenceF0, which is estimated by a Gaussian mixture model with two components fitted on the raw fluorescence data. The mean parameter of the lowest Gaussian component is used asF0. To be able to compare calcium activity across sessions and mice,z-scored ΔF/Fwas computed by subtracting the mean value of ΔF/Fof a session and dividing the resulting trace by the standard deviation.

*** The response to each grating was calculated using the meanz-scored ΔF/Fcalcium signal averaged over a window from 0.4 s to 2 s after grating onset, baseline-subtracted using the meanz-scored ΔF/Fsignal during 0.5 s before stimulus onset for each grating presentation. Neurons were classified as stimulus-responsive if their mean response was bigger than 0.5z-scored ΔF/F. In Fig.1, cell-averaged calcium traces are from neurons responsive to the presented grating in trials with unexpected C or D (block 1), trials with expected C or D trials (late block 2) or both. For comparison, Extended Data Fig.2shows cell-averaged calcium responses of all neurons responsive to any grating. In Fig.2a,band Extended Data Figs.5u–zand6a,b, cells were defined as prediction-error-responsive if the responses were significantly different between unexpected stimuli C4, D4 or stimulus omission (block 1) and expected stimuli C4, D4 or stimulus omission (second half of block 2, two-sidedt-test;α= 0.05; unexpected C4, D4 or omission versus expected C4, D4 or omission) and the difference in response was larger than 0.5z-scored ΔF/F. Similarly, in Extended Data Figs.5e,pand7e, cells were defined as prediction-error-responsive if the responses were significantly different between unexpected C4 or D4 (block 1) and expected C4 or D4 (second half of block 2, two-sidedt-test;α= 0.05; unexpected C4 or D4 versus expected C4 or D4) and the difference in response was larger than 0.3z-scored ΔF/F. In Fig.3f,g,m,n, average response in LED on and off trials was used for classification of stimulus-responsive cells to avoid selection bias towards LED off trials. In Fig.4, response in LED off trials was used for classification of stimulus-selective cells to avoid inclusion of opsin-expressing, therefore directly activated VIP cells. In Fig.5and Extended Data Fig.12, SOM cells or VIP cells were defined as ‘recruited’ if their responses were significantly different between with and without optogenetic pulvinar axon stimulation (two-sidedt-test;α= 0.016; with versus without LED light stimulation) and the difference in response was larger than 0.3z-scored ΔF/F, during at least one of the visual stimulus presentations (expected B4, unexpected C4 or D4, expected C4 or D4). In Extended Data Fig.5f–k, cells were defined as prediction-error (C or D) responsive but not responsive to expected C or D if the responses were significantly different between unexpected C4 or D4 and expected C4 or D4 (two-sidedt-test;α= 0.05) and the difference in response was larger than 0.5z-scored ΔF/F, but the response to expected C4 or D4 was smaller than 0.5z-scored ΔF/F. In Extended Data Fig.6g,h, in which raw ΔF/Frather thanz-scored ΔF/Fwas used, neurons were defined as stimulus-responsive if their stimulus response strength was larger than 0.2 ΔF/Fin the second half of block 2. In Extended Data Fig.7j,k, boutons were defined as stimulus-responsive if the response to any expected stimulus in late block 2 was larger than 0.1z-scored ΔF/F.

*** To quantify the selectivity of neural responses we computed a response selectivity measure for individual V1 layer 2/3 cells and pulvinar boutons:

*** WhereRC4 or D4is the mean response to the gratings C4 or D4 in late block 2, andRA3 or B2is the mean response to the gratings A3 or B2 in late block 2. Selectivity values of >1 or <−1 were shown as 1 or −1, respectively. If selectivity of neurons responsive to a specific visual stimulus was less than 0.6 or more than 0.8, they were classified as either non-selective or highly selective to that stimulus, respectively. We also used an additional selectivity index (SI) to quantify response selectivity of individual pulvinar boutons (Extended Data Fig.7l–n), since this index provided a more reliable measure for the noisy bouton calcium traces. SI was calculated as previously described71. In brief, it was computed from the difference between the mean response to the expected stimulus C4 or D4 and expected stimulus B2 in late block 2, divided by the pooled standard deviation of the responses.

*** For the analysis in Extended Data Fig.1k,l, trials in block 1 and 2 were divided into fast and slow running trials based on mean running speed during presentation of grating C4. A time window starting 0.4 s and ending 2 s after the grating onset, similar to the response window used for calcium responses, was used to calculate the mean running speed. A trial was defined as ‘fast’ or ‘slow’ if the mean running speed during the time window was in the top 50th or bottom 50th percentile of all visual stimulus C4 presentations in block 1 or 2.

*** To determine the effect of running speed on neuronal activity (Extended Data Fig.1m,n), we computed for each cell the correlation between mean ΔF/Fand mean running speed in a time window (starting 0.4 s and ending 2 s after grating stimulus onset) of each trial in block 1 or 2. For the analysis in Extended Data Fig.1o, we used the square of the correlation coefficient (R2, coefficient of determination) of running speed and ΔF/Facross the recording, to quantify the strength of the modulation of neural responses by running speed across the entire session (block 1 and 2).

*** Pupil size was computed offline. The pupil was detected using a binary threshold and centre of mass of the detected regions. We then applied a one-dimensional filter to the traces using the filloutlier function in MATLAB.

*** We used two-sided Wilcoxon signed-rank tests for comparisons across animals and hierarchical bootstrapping test for comparisons across cells unless otherwise stated. Hierarchical bootstrap procedure was performed as previously described72,73. In short, we first randomly resampled animals with replacement and then resampled cells with replacement from each of the resampled animals. We then randomly shuffled the paired data and calculated the statistic of interest. This process was repeated 10,000 times. The statistic values were compared against the value of the original data to calculatePvalues. Where relevantPvalues were adjusted for multiple comparisons using Bonferroni correction, as indicated in the figure legends. For the randomization test, we computed the statistic of interest with randomly shuffled data (10,000 times). The statistic values were compared against the value of the original data to calculatePvalues. All tests were performed using MATLAB. Mean and bootstrap 95% confidence intervals were used for display purposes, as stated in the figure legends. Confidence intervals were estimated using bootci function in MATLAB, with 10,000 bootstrap samples with replacement. Cohen’sdwas computed from the difference between the two mean responses, divided by the pooled standard deviation of the responses. No statistical methods were used to predetermine sample sizes, but our sample sizes are similar to those generally used in the field. Experimenters were not blinded to experimental groups. Animals were allocated to experimental groups pseudo-randomly, and trial types (expected or unexpected stimuli, with or without optogenetic manipulation) were randomly interleaved.

*** Further information on research design is available in theNature Portfolio Reporting Summarylinked to this article.

