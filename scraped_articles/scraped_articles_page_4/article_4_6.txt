*** Many animals use visual information to navigate1,2,3,4, but how such information is encoded and integrated by the navigation system remains incompletely understood. InDrosophila melanogaster, EPG neurons in the central complex compute the heading direction5by integrating visual input from ER neurons6,7,8,9,10,11,12, which are part of the anterior visual pathway (AVP)10,13,14,15,16. Here we densely reconstruct all neurons in the AVP using electron-microscopy data17. The AVP comprises four neuropils, sequentially linked by three major classes of neurons: MeTu neurons10,14,15, which connect the medulla in the optic lobe to the small unit of the anterior optic tubercle (AOTUsu) in the central brain; TuBu neurons9,16, which connect the AOTUsu to the bulb neuropil; and ER neurons6,7,8,9,10,11,12, which connect the bulb to the EPG neurons. On the basis of morphologies, connectivity between neural classes and the locations of synapses, we identify distinct information channels that originate from four types of MeTu neurons, and we further divide these into ten subtypes according to the presynaptic connections in the medulla and the postsynaptic connections in the AOTUsu. Using the connectivity of the entire AVP and the dendritic fields of the MeTu neurons in the optic lobes, we infer potential visual features and the visual area from which any ER neuron receives input. We confirm some of these predictions physiologically. These results provide a strong foundation for understanding how distinct sensory features can be extracted and transformed across multiple processing stages to construct higher-order cognitive representations.

*** The AVP encodes visual features that are essential for navigation, potentially including landmarks, intensity gradients, colour, celestial bodies and skylight polarization1,5,11,18,19,20,21,22. Considering its fundamental role in navigation, it is not surprising that this anatomical structure is largely conserved across most known insect species10,23,24,25. It is likely that deep similarities exist across species in the basic logic of visual feature extraction for navigation19,23,24,25,26,27,28. However, despite many studies of the AVP across species, researchers’ knowledge about the AVP neurons has been fragmented by the lack of a complete circuit diagram to frame systematic investigations. Here we aim to provide such a framework in flies, and we anticipate that this will also be invaluable for designing and prioritizing physiological experiments to interrogate the AVP in other species.

*** We identified all neurons (Fig.1) and their connectivity (Supplementary Data1) in the AVP, using a publicly available electron-microscopy (EM) dataset (full adult female brain, FAFB) that contains the entire adult fly brain, with FlyWire, an AI-assisted collaborative platform17,29,30(Extended Data Fig.1). MeTu neurons, the first stage of the AVP, leave the medulla, the largest neuropil in the fly visual system31,32,33,34,35,36. The axons of MeTu neurons innervate the AOTUsu10,14,16,32,37,38(Fig.1a,b), where the information is further processed by the TuBu neurons that connect the AOTUsu to the bulb10,11,38(Fig.1a–dand Supplementary Data1fi,ii). There are ten classes of TuBu neurons (Fig.1c), each synapsing onto the dendrites of distinct classes of ER neurons (Fig.1a,band Supplementary Data1fiii,iv). ER neurons then send ring-like processes to a donut-shaped structure, the ellipsoid body16,39,40(Fig.1a), where they together form a complex recurrent neural network5,41,42(Fig.1band Supplementary Data1e). Finally, the visual information from the AVP—along with other sensory modalities43—is compiled to compute the heading direction by EPG neurons5that share many similarities with mammalian ‘head direction’ cells5.

*** a, Diagram of theD. melanogastercentral brain, emphasizing the AVP. Important regions are darker grey, including the medulla, AOTU, bulb and ellipsoid body (the former three have counterparts in both hemispheres). The three crucial neurons of the AVP are MeTu (purple), TuBu (yellow) and ER (cyan).b, All MeTu (n= 453 left;n= 441 right), TuBu (n= 75 left;n= 75 right) and visual ER (n= 116 left;n= 116 right) neurons.c, Left, synapse plots of TuBu (left) and MeTu (middle) neurons in the posterior lateral (red), posterior central (blue), anterior (green) and medial (yellow) region of the AOTUsu. Right, renders of TuBu in the AOTUsu_R (top) and MeTu in the AOTUsu_R (middle) and ME_R (bottom) with the same regional colours as the synapse plots on the left. Coordinates: A, anterior; R, lateral side of the right hemisphere; P, posterior; V, ventral.d, Synaptic weight matrices of MeTu type (top) or MeTu subtype (bottom) to TuBu type connectivity (right hemisphere).e, All neurons of types MeTu1 (far left), MeTu2 (left middle), MeTu3 (right middle) and MeTu4 (far right).f, UMAPs of all MeTu neurons with identified upstream partners on the basis of the synaptic weight of both the top five medulla input neuron types and AOTU output neuron types (top), or just the top five medulla input types (bottom) (seeMethodsfor details). Groupings are generally consistent with MeTu1–MeTu4 groups in the main text, except MeTu3a neurons, which are closer to MeTu2 neurons (because of the similar polarization input) than other MeTu3 neurons.g, Synaptic weight matrix of all MeTu neurons with identified upstream partners (columns) and their AOTU output partners (red top rows) and top five medulla input types (teal bottom rows). Dendrogram branches and column labels are colour-coded according to MeTu. See Supplementary Data1h,ifor analyses with entire MeTu neurons.

*** Our survey of the entire brain29showed that visual information originating from optic lobe structures outside the AVP (the lobula and the lobula plate) constitutes minimal input to EPG neurons (Extended Data Fig.2). Thus, we focused our analyses on the medulla-originating AVP. Furthermore, although previous anatomical studies of various types of MeTu neuron have generally agreed at the macroscale10,14,15(Extended Data Fig.1d), the insufficient resolution of light microscopy has resulted in considerable inconsistencies in grouping MeTu types and predicting their connectivity towards the central complex (seeMethodsfor a more detailed discussion on the differences). Hence, we sought to provide a comprehensive view of this pathway in synapse-level detail. Finally, although the connectivity from TuBu to ER to EPG neurons has been studied at synaptic resolution16(a dataset we refer to here as hemibrain data), this dataset contains only one hemisphere and lacks upstream medulla neuropils and photoreceptor terminals. Therefore, we sought to reconstruct the entire AVP in both hemispheres (Supplementary Data1) to provide a solid foundation for understanding how brains vary across hemispheres and across animals, as well as which visual features are extracted in the AVP.

*** We densely proofread all MeTu neurons (453 on the left hemisphere, 441 on the right; Fig.1a,band Supplementary Data2), TuBu neurons (75 on the left, 75 on the right), and ER neurons (116 on the left, 116 on the right). We further reconstructed all medulla-intrinsic Mi1 neurons in the medulla (782 on the left and 792 on the right31) from both hemispheres (Extended Data Fig.1e) to map the exact locations of all reconstructed neurons relative to the retinotopic columns in the medulla. To assess our proofreading quality29, we selected 113 (of 441) MeTu neurons from the right hemisphere and performed multiple rounds of proofreading (Extended Data Fig.1b). We found that—after the first round—any additional volume reconstructed in each round markedly decreased and there were no changes in the main backbone (Extended Data Fig.1bii). Moreover, all MeTu neurons (894 neurons—both hemispheres and including neurons with a single round of proofreading) shared stereotypical arborization patterns in the medulla. Therefore, we were confident that our reconstruction quality of the 894 MeTu neurons was sufficiently accurate for categorization and morphological and connectivity analyses.

*** We focused on the detailed connectivity of MeTu neurons because the logic of their connections between optic lobes and the central brain was missing in previous studies16. We included results from both hemispheres in most analyses, but, where indicated, some detailed analyses were restricted to the right hemisphere because the left hemisphere had an incomplete lamina and (minor) EM image alignment issues17,29,44.

*** The AOTUsu is innervated by four types of processes: the axons of MeTu neurons; the dendrites of downstream TuBu neurons (Fig.1c); and the synaptic terminals of bilaterally projecting AOTU046 and tubercle-to-tubercle (TuTu) neurons16. Drawing on the axonal arborization pattern of MeTu and the dendritic arborization pattern of TuBu, we divided the AOTUsu into four major subregions: posterior lateral (AOTUsu_PL), posterior central (AOTUsu_PC), anterior (AOTUsu_A) and medial (AOTUsu_M; Fig.1c, left). These anatomical divisions led us to categorize MeTu neurons into four major classes (MeTu1–MeTu4; Fig.1c–e). Downstream TuBu neurons were categorized into ten types, consistent with previous works (Fig.1c, left; TuBu1–TuBu10; numbering follows the nomenclature of a previous study16). See Extended Data Fig.3for a detailed anatomical description of these four areas and the neurons that innervate them.

*** Within each MeTu class except MeTu1, we observed discrete morphologies and anatomical innervations, suggesting multiple channels for visual features. To systematically categorize all possible MeTu neuron subtypes, we focused our analysis on the 5 strongest synaptic partner types; this resulted in 28 types of upstream neuron. Applying a nonlinear dimensionality reduction analysis (uniform manifold approximation and projection; UMAP) based on the connectivity in the medulla but not in the AOTUsu revealed four major patterns of presynaptic inputs, mostly consistent with the four major MeTu classes defined in the previous section (Fig.1fand Supplementary Data1h). We also performed categorization analyses (Fig.1gand Supplementary Data1i) and found ten subtypes. Comparing the expression pattern of genetic driver lines (seeMethods) with EM data further corroborated our subtyping of MeTu neurons.

*** Compass neurons are strongly influenced by vertical stripes and their locations in azimuth5,7, whose information is conveyed by ER neurons, probably ER4d6,9,12,39. This ER neuron type is the only partner downstream of TuBu08, which is, in turn, the only neuron type downstream of MeTu1 neurons (Figs.1dand2): Our analysis of the anatomy and connectivity of MeTu1 neurons helps to explain the mechanisms that underlie the selectivity of ER4d neurons.

*** a, A single MeTu1_R neuron with presynapses (red) and postsynapses (cyan). Corner: magnified view of AOTUsu portion. Scale bar, 10 μm.b, Top view of the same neuron spanning medulla columns (grey).c, Side view of the neuron ina,b, with medulla layers labelled.d, Synapse distribution of the individual neuron ina–c(left) and of all MeTu1_R neurons (right) within medulla layers (as count per 100 nm or relative frequency, respectively).e, Medulla input percentage of the top five synaptic input types and unidentified types for analysed neurons (n= 18, black; seeMethods) and all MeTu1_R neurons (n= 124, grey); mean and s.d. in red.f, All MeTu1_R neurons with synapses. Scale bar, 10 μm.g, Confocal image of MeTu1-specific split-GAL4 driver (SS00385).h,i, MeTu1 MultiColor FlpOut (MCFO) image, from anterior (h) and medial (i) medulla views.j, MeTu1_R neurons froma(black), with all upstream Dm2 partners. Scale bar, 10 μm.k, Side view of same MeTu1_R neuron (grey) and one Dm2 partner (blue, with red presynapses).l, Top left, synapse density of one MeTu1 neuron. Top right, equal area annuli (314.15 µm2). Bottom, synapse density for each annulus (red averages).m, Percentage of output (red) and input (cyan) of analysed MeTu1 neurons with TuBu (top) and upstream partners (bottom).n, Diagram of analysed MeTu1 top medulla inputs.o, Illustration of MeTu1’s dendritic span with elliptical measurement (seeMethods).p, Top, all MeTu1_R ellipse ratios (semi-major axis to semi-minor axis) plotted against ellipse angles. Bottom, ellipse angles’ relative frequencies (Rayleigh test of uniformity:P= 2.061 × 10−13, z-value = 0.345, mean ellipse angle = 29.1).q, Ellipses of all MeTu1_R, semi-major axes (black lines) and ellipse angles (colour range).r, Number of columns spanned by each MeTu1_R.s, Number of MeTu1_R bounded by each medulla column (grey if none).t, All TuBu08_R rendered from the AOTUsu_R lateral side (n= 11).u, MeTu1 retinotopy. Top, three MeTu1_R neurons (red, blue and green) with similar dorsal–ventral medulla positions. Bottom, all MeTu1_R AOTUsu dorsal–ventral positions plotted against medulla posterior–anterior positions.

*** MeTu1 neurons (n= 121 left andn= 124 right; Fig.2) form thick dendritic branches in the medulla layer 7, with small vertical protrusions extending to layer 6 (Fig.2c,d). Dendrites span about 30–40 medulla columns (Fig.2b,r) and each medulla column is innervated by multiple MeTu1 neurons (Fig.2s). MeTu1 neurons receive the strongest input from Dm2 neurons covering the entire visual field (Fig.2e,m,n; on average, 36 Dm2 neurons make 311 synapses per MeTu1 neuron), followed by Sm16 (serpentine layer neurons in medulla; following the FlyWire nomenclature45,46; see ref.47for matches between FlyWire names and male optic lobe names), MeTu1 (Supplementary Data1ai,ii), Sm15 and Sm07 (Fig.2e,m,n). The density of synapses drops at a distance of 20 to 30 µm from the medulla centroid of a MeTu1 neuron (Fig.2l, bottom). The functional implication of recurrent connections between MeTu1 neurons in the medulla remains to be examined. The orientation of the MeTu1 dendritic span, when fitted with a two-dimensional Gaussian function, tends to be vertical. We observe that, near the anterior and posterior edges, the dendritic spans of MeTu neurons narrow (Fig.2p,q), but future studies are required to ascertain whether this change has functional implications.

*** MeTu1 neurons project axons to the AOTUsu_PL, where they synapse with TuBu08 neurons (Figs.1dand2m, Extended Data Fig.4and Supplementary Data1ji), among other connections (Extended Data Fig.4aand Supplementary Data1fi,ii). The connection from MeTu1 neurons to TuBu08 neurons is retinotopic; the more anteriorly or posteriorly MeTu1 dendrites are located in the medulla, the more ventrally or dorsally they project in the AOTUsu_PL, respectively (Fig.2u). In other words, each TuBu08 neuron receives input from a group of MeTu1 neurons at a particular azimuth, regardless of their elevation in the medulla. Such one-dimensional mapping provides a potential anatomical basis for the selectivity of TuBu08 neurons to vertical bars or to the azimuthal location of visual stimuli, but not to elevation (Supplementary Video1), an anatomical structure similar to the classic Hubel & Wiesel model of how simple cells in the mammalian primary visual cortex receive input from the lateral geniculate nucleus in the thalamus48.

*** Many insects navigate relying on skylight polarization18,20,22,49. InDrosophila, ER4m neurons are the prominent ER neurons that process skylight polarization11,16. MeTu2 neurons (Fig.3a,d, left and Extended Data Fig.5), previously designated as MeTu-DRA37are notable as the only upstream inputs of these ER neurons16(Supplementary Data1e; through TuBu01 for ER4m; through TuBu06 in addition for ER5). They are clustered in the dorsal half of the medulla, with dendrites mainly tiling the dorsal rim area (DRA) (Extended Data Fig.5a,r), where neurons process skylight polarization11,35,50.

*** a–c, Renders and retinotopy of MeTu2, MeTu3 and MeTu4, respectively.a, Left, render of MeTu2a_R (blue,n= 36) and MeTu2b_R (orange,n= 14).b, Left, render of MeTu3a_R (blue,n= 19), MeTu3b_R (orange,n= 46) and MeTu3c_R (green,n= 64).c, Left, render of MeTu4a_R (blue,n= 60), MeTu4b_R (orange,n= 12), MeTu4c_R (green,n= 48) and MeTu4d_R (purple,n= 18).a–c, Top right, AOTU dorsal–ventral positions plotted against medulla (ME) anterior–posterior positions for each neuron of the respective types. This retinotopy is maintained in all types. Bottom right, AOTU medial–lateral positions plotted against medulla dorsal–ventral positions for each neuron of the respective types. This retinotopy is seen mainly in MeTu3c.d, Top medulla input types of analysed MeTu neurons (seeMethods) for MeTu2 (left), MeTu3 (middle) and MeTu4 (right). Percentages of input contribution to each type are shown.

*** Our clustering analysis identified two MeTu2 subtypes (Extended Data Fig.5kand Supplementary Data1jii) with distinct ramifications in the medulla and notably distinct connectivity patterns in the AOTUsu_PC (Supplementary Data1ciii=iv), which we named MeTu2a (n= 33 left andn= 36 right; Fig.3d, left) and MeTu2b (n= 17 left andn= 14 right). Both subtypes exhibit generally vertical arborizations and similar dendritic spans (Extended Data Fig.5n–p), but the interconnectivity between MeTu2b in the medulla is much stronger than that between MeTu2a (Supplementary Data1aiii,iv,biii,iv). Furthermore, MeTu2b neurons appear to receive more input from MeTu2a than they provide input to MeTu2a. Finally, although both MeTu2 subtypes mainly stratify within medulla layer 7 (Extended Data Fig.5b,d), MeTu2a neurons are postsynaptic to polarization-sensitive R7 neurons only in the DRA and local interneurons DmDRA1, both of which are potentially sensitive to light polarization as well37, whereas MeTu2b inputs also include Mi15, the function of which remains unknown, and a stronger connection from interhemispheric MeMeDRA37(Extended Data Figs.5e,kand3di). Hence, MeTu2b might integrate additional inputs from the contralateral hemisphere, enabling the processing of a more global skylight polarization pattern.

*** MeTu2 innervation of the AOTUsu respects the same topographic rules as those described for MeTu1 (Fig.3aand Extended Data Fig.5m; MeTu2 neurons with dendrites in the anterior medulla project axons ventrally; those with posteriorly localized dendrites project dorsally in the AOTUsu_PC). Also, as in the medulla, MeTu2b neurons are more strongly interconnected in the AOTUsu than are MeTu2a neurons (Supplementary Data1biii,iv). Moreover, although MeTu2a and MeTu2b both synapse onto TuBu01 and TuBu06, MeTu2b is only weakly connected to TuBu01 (Extended Data Fig.5kand Supplementary Data1ciii,iv). Finally, MeTu2a and MeTu2b differ in their connections to the bilateral neurons TuTuB_a and TuTuB_b (Extended Data Figs.5a,band4a,d). Overall, these connectivity differences in the AOTUsu_PC, combined with their distinct anatomical features in the medulla, indicate that MeTu2a and MeTu2b are likely to convey distinct features of skylight polarization to downstream circuits, with MeTu2b processing potentially more complex and global polarization patterns.

*** TheDrosophilacompass neurons can use the two-dimensional organization of the surrounding world to compute the head direction7, but the source of this information was unclear. Here, we provide evidence that MeTu3 (Fig.3b,d, middle and Extended Data Fig.6) and its downstream neurons process, in addition to skylight polarization (through ER3w_ab), the two-dimensional organization of the scene (through ER2_ad, ER2_b and ER2_c).

*** Our connectivity analysis identified three distinct MeTu3 subtypes (MeTu3a, MeTu3b and MeTu3c; Fig.3d, middle, Extended Data Fig.6land Supplementary Data1jiii) with regionalized clusters of dendrites (Extended Data Fig.6a). MeTu3a (n= 20 left andn= 19 right; Extended Data Fig.6ai–ei) has dendrites that cluster in the dorsal third of the medulla (similar to MeTu2), are confined to layer 7 (Extended Data Fig.6bi,di) and specifically lack vertical protrusions across medulla layers (Extended Data Fig.6bi,di). MeTu3a is the only MeTu3 subtype that receives polarization information through input from DmDRA1, similar to MeTu2a and MeTu2b. MeTu3b cells (n= 53 left andn= 46 right) have dendrites that are clustered most densely in the dorsal half of the medulla but also extend to the ventral two-thirds, with pronounced vertical protrusions that cover layers 5, 6 and 7 (Extended Data Fig.6bii,dii). They receive direct inhibitory input from ultraviolet (UV)-sensitive R7 photoreceptors and indirect input from blue/green-sensitive R8 cells37through Mi15, which suggests that they have a role in processing chromatic information (Extended Data Figs.6ei,ii,l,mand7). MeTu3c cells (n= 72 left andn= 64 right) have dendrites that are more ventral than those of MeTu3b, covering the equator and some of the ventral part of the medulla (Extended Data Fig.6biii,eiii). Dendritic processes innervate the same layers (5, 6 and 7) as MeTu3b and receive the same direct and indirect photoreceptor inputs (Extended Data Fig.6eiii), suggesting similar chromatic coding to that of MeTu3b.

*** MeTu3 innervation of the AOTUsu_A respects the same topographic rules as those described for MeTu1 and MeTu2 (anterior–posterior axis in the medulla to ventral–dorsal axis in the AOTUsu_A; Fig.3band Extended Data Fig.6h). Axons of MeTu3a, MeTu3b and MeTu3c are not well segregated in the AOTUsu_A, despite the downstream TuBu neurons (TuBu07, TuBu09 and TuBu10; Supplementary Data1cv,vi) having well-segregated dendrites16(Fig.1cand Extended Data Fig.3c). Consequently, some MeTu3 neurons are connected to two TuBu types (Extended Data Fig.6land Supplementary Data1cv,vi,jiii). All three MeTu3 subtypes are strongly and reciprocally connected to bilateral TuTuB_a neurons (Extended Data Fig.4gand Supplementary Data1fi,ii). Because the TuTuB_a neurotransmitter is predicted to be inhibitory51(Extended Data Fig.4ei), MeTu3 neurons might exhibit strong bilateral inhibitory interactions across the entire visual field.

*** MeTu3a and MeTu3b neurons are mainly connected to TuBu07, upstream of ER3w_ab. This convergence of MeTu3a and MeTu3b suggests that ER3w_ab encodes a combination of skylight polarization and chromatic information of the sky. On the other hand, MeTu3c neurons are mostly presynaptic to both TuBu09 and TuBu10 (Extended Data Fig.6land Supplementary Data1cv,vi). Notably, TuBu09 neurons receive input from MeTu3c neurons with dendrites located more dorsally in the medulla, whereas TuBu10 neurons receive input from MeTu3c neurons with dendrites located more ventrally in the medulla (Extended Data Fig.6hii, red dots). Thus, the neurons downstream of MeTu3c can encode the elevation of visual stimuli (for example, the Sun) or a two-dimensional organization of visual objects in a surrounding scene. This capability is unique among all MeTu neurons.

*** Compass neurons receive diverse input from ER neurons, some of which exhibit responses to the contralateral visual field and self-generated motion signals12,39. Considering that these ER neurons, the dendrites of which are in the inferior bulb, are downstream of MeTu4 neurons (Fig.3c,d, right, Extended Data Fig.8and Supplementary Data1cvii,viii,dvii,viii) that originate in the ipsilateral optic lobe, their response pattern was puzzling. Our analyses show that MeTu4 neurons receive inputs from distinct parts of the visual world (dorsal, frontal or ventral), with virtually no input from a columnar medulla cell type. Instead, they receive input mostly from large interneurons that span many medulla columns (Sm neurons) and from others that potentially convey motor information from a neuropil called the superior posterior slope (SPS) to the medulla (Extended Data Fig.8e). These unique properties of MeTu4 might explain the mysterious properties of ER neurons in the inferior bulb12,39.

*** On the basis of the connectivity in the medulla and the AOTUsu_M, we categorized MeTu4 into four subgroups: MeTu4a, MeTu4b, MeTu4c and MeTu4d (Extended Data Fig.8a). The dendrites of MeTu4a cells (n= 69 left andn= 60 right) cluster densely in the dorsal half of the medulla but also extend ventrally (Extended Data Fig.8ai,mi), with unique arborization in two medulla layers (M6 and M7; Extended Data Fig.8b,d). Despite their dorsal location, they form no synaptic connections with polarized light-sensitive photoreceptors or DRA neurons. MeTu4b neurons (n= 8 left andn= 12 right) are notable for their unique dendritic arrangement: they span a rather small area in the equator, mostly in the posterior–medial part of the medulla that represents the frontal central visual field (because of the crossover connections from the lamina to the medulla along the anterior–posterior axis; Extended Data Fig.8aii,mii). The function of this spatial restriction remains unknown (see also the next section about variance across brains). MeTu4c neurons (n= 41 left andn= 48 right) span the entire dorsal half of the medulla (Extended Data Fig.8aiii,miii), whereas MeTu4d neurons (n= 19 left andn= 18 right) cluster exclusively in the ventral half of the medulla (Extended Data Fig.8aiv,miv) and are ideally positioned to detect features in the ventral visual field. Both MeTu4c and MeTu4d receive nearly identical input from a wide variety of interneurons, including those that convey information from other brain areas, such as the SPS (Extended Data Figs.8eiii,iv,kand3diii).

*** Like all other MeTu types, axonal projections of all MeTu4 neurons maintain anterior–posterior retinotopy in the AOTUsu_M along the ventral–dorsal axis (Fig.3c, Extended Data Fig.8j), in contrast to what was found in a previous report14. MeTu4a, MeTu4b and MeTu4c also have presynaptic connections in the lobula (Extended Data Fig.8ai–iii), but these connections do not contribute to the AVP and were thus excluded from further analyses. In the AOTUsu_M, all MeTu4a neurons are presynaptic to TuBu03; some are also presynaptic to TuBu04 (Supplementary Data1f). MeTu4b neurons are presynaptic to TuBu02 neurons. Both MeTu4c and MeTu4d subtypes are mainly presynaptic to TuBu05 (Supplementary Data1cvii,viii), but MeTu4d also makes presynaptic connections with TuBu02. MeTu4b and MeTu4c receive the main interhemispheric connections within the AOTUsu_M (Extended Data Fig.4a,band Supplementary Data1fi,ii): MeTu4b receives strong input from AOTU046 but does not provide reciprocal input into AOTU046, whereas MeTu4c is strongly and reciprocally connected to AOTU046. MeTu4d receives no input from AOTU046, and provides only weak input to AOTU046. Finally, MeTu4d receives weak input from TuTuB_a.

*** We compared the AVP within17,44and across brains16,47(Extended Data Fig.9). Although our analyses are limited, owing to the lack of optic lobes in the hemibrain dataset and a single optic lobe in the male brain dataset, tentative comparisons are still possible for most MeTu types, on the basis of synapses in the AOTU (hemibrain) or optic lobe synapse and cell shapes (male optic lobe). The number of neurons of each type was very similar across hemispheres of the same brain (in both FAFB and hemibrain), compared to the difference across brains. Notably, across brains, only a few cell types showed clear differences in spatial arborization patterns, numbers or, in very few cases, perhaps even their existence (for example, MeTu3c, MeTu4b, MeTu4e, MeTu4f, TuBu9, ER2_ad, ER3d_a and others; Extended Data Fig.9). For example, MeTu4b neurons in FAFB (the dataset used here) and the male brain optic lobe both have similar spatially restricted arborizations in the medulla, but the FAFB pattern lacks a few cells (in the lateral and frontal medulla) that are present in the male optic lobe MeTu4b population. Also, the overall number of MeTu4 cells in the male brain dataset is higher and two other MeTu4 subtypes (MeTu4e and MeTu4f) are identified. Careful comparison suggests that MeTu4e in the male optic lobe could be a subset of MeTu4a in FAFB (the segregation of morphological and connectivity patterns between candidate MeTu4e and the remaining MeTu4a appears less clear in FAFB and there are fewer MeTu4e-like neurons; Extended Data Fig.9i). The source of such variations across brains remains incompletely understood but is likely to be, at least in part, developmental in nature52.

*** A common pattern across all AVP channels is the convergence of MeTu neurons onto a considerably smaller number of TuBu neurons (Extended Data Fig.9eand Supplementary Data1c). In this transformation, each TuBu neuron integrates information from a large area of the visual field, suggesting spatial feature processing with a lower resolution. TuBu neurons also receive strong input from the contralateral visual field through TuTu neurons (Extended Data Fig.6). Note that individual MeTu neurons sample the visual area differently depending on their location in the medulla over the anterior–posterior axis. This results in synapse counts and dendritic field shapes differing by their locations in the medulla along this axis (Extended Data Fig.10). The effect of this pattern on TuBu integration is not understood at present. The next step in processing—from TuBu to ER neurons—exhibits a re-expansion in the number of neuronal types (from 10 TuBu types to potentially 18 ER neuron types in hemibrain, or 14 ER neuron types in FAFB). The ratio of connections from TuBu to ER neurons (Extended Data Fig.9fand Supplementary Data1d; see also ref.16) varies between 0.33 and, for some neurons, 4 (Extended Data Fig.11). Thus, the transformation from TuBu to ER may extract several more visual features.

*** To quantify the putative visual area to which each neuron probably responds, we mapped each medulla column (Extended Data Fig.1e) to a micro-computed tomography (microCT)-based eye map ofD. melanogaster53(Supplementary Data4). Then, for each ER neuron, we back-traced the upstream connections in two ways: one followed TuBu to MeTu connections (we call this the direct pathway, putatively excitatory; Fig.4a, Extended Data Figs.11and12and Supplementary Videos1–3) and the other followed TuBu to TuTu to ipsi- and contralateral MeTu connections (we call this the indirect pathway, putatively inhibitory; Fig.4band Extended Data Fig.4d–f). We used the dendritic arborization in the medulla for each pathway to estimate the area of a direct pathway or an indirect pathway. We overlaid them into a single putative receptive field (Fig.4c,d), which we further analysed to obtain the outline of the visual field of the direct pathway. We then combined outlines of the same type of ER neurons to illustrate the visual area that the population of ER neurons covers (Fig.4e). Note that the lack of functional data for most optic lobe cell types, including Sm neurons, hinders extensive functional predictions. Thus, our predictions are based mainly on the dendritic fields of MeTu neurons and the known properties of presynaptic neurons.

*** a, Direct pathway (putatively excitatory). Left, all connected TuBu and upstream MeTu neurons for a given exemplary ER neuron. Middle, connectivity graph illustration of the direct pathway. In red are all branches connecting to one given column. Right, resulting putative visual area. The eye map was developed using microCT data. Scale bar, 10 μm.b, Indirect pathway (putatively inhibitory). Left, all connected TuBu, upstream TuTu and upstream MeTu neurons for a given exemplary ER neuron. Middle, connectivity graph illustration of the indirect pathway. In blue are all branches connecting to one given column. Right, resulting putative visual area. We did not analyse the AOTU046 pathway because its neurotransmitter was not conclusive51. Scale bar, 10 μm.c, Overlaid direct and indirect visual areas predicted froma,b.d, Visual area size as the number of covered columns for all visual ER neurons of the right hemisphere. Red point: population average.e, For all visual ER types (columns) of the right hemisphere, we show an exemplary visual area of individual neurons (top of each ER type) and a contour outline of the visual area of all neurons of a given ER type (bottom of each ER type). ER2_ad_R,n= 3; ER2_b_R,n= 5; ER2_c_R,n= 13; ER3a_ad_R,n= 13; ER3d_a_R,n= 11; ER3d_b_R,n= 7; ER3d_c_R,n= 5; ER3d_d_R,n= 3; ER3m_R,n= 7; ER3p_ab_R,n= 8; ER3w_ab_R,n= 13; ER4d_R,n= 13; ER4m_R,n= 5; ER5_R,n= 11; ExR1_R,n= 2.

*** Back-tracing the synaptic pathway starting from an ER4d revealed that its upstream MeTu1 neurons are aligned vertically in the medulla (Supplementary Video1). They cover about 40° azimuth and the entire vertical span (Fig.4e). This vertical arrangement of MeTu1 neurons was consistent across ER4d neurons and covered the entire visual field as a population, like an array of vertical bars (Figs.4eand5and Extended Data Fig.13). It suggests that ER4d neurons are selective to vertically elongated visual stimuli or to the location of visual stimuli along the horizontal plane, regardless of the elevation. Such a pathway would be best suited for detecting visual landmarks that are appropriate references for setting a heading.

*** a, Putative receptive fields for ER4d and ER2.b, Confocal image of ER neuron driver lines. Left, ER4d split-GAL4 line (SS04147). Right, ER2 Gal4 line (VT059775). Dendrites of ER4d and ER2 innervate the superior bulb (BUs). Scale bars, 50 µm. EB, ellipsoid body.c, Imaging set-up. Fly heads were tilted 30–45oto expose the left eye to the stimulus. IR, infrared.d, The stimulated visual area in the fly’s eye coordinates.e, The projection of the 38 predetermined squares (dots) on the screen. In each trial, a single dot was back-projected on the screen for 1 s, followed by 1 s of darkness.f, Snapshots of two-photon calcium imaging video of ER4d neurons in the BUswith an overlay of regions of interest (ROIs) selected on the basis of responses to stimuli. Individual ER neurons form a microglomerulus in the bulb. ER neurons (ROI1–ROI3) respond to dots appearing at different positions. Scale bars, 3 μm. Coordinates: D, dorsal; M, medial.g, Calcium activity (ΔF/F) of ROI1–ROI3 (left to right) before and during stimulation (n= 10 trials each; ROI1P= 0.0020, ROI2P= 0.0030, ROI3P= 0.0039; Wilcoxon signed-rank test).h, Top, average calcium traces of ten trials of ROI2 infarranged in the eye coordinates. Bottom, an ROI from an example ER2 neuron.i, Receptive field contour plot, contours at 20% (lighter shade) and 50% (darker shade) maximum ΔF/Fof individual ROIs. Top, data are from ROI1–3 shown inf.j, Fitted ellipses at 20% contour. Dots represent the ellipses’ centroids.k, Fitted ellipses at 20% contour of ROIs collected from 11 flies (ER4d: 29 ROIs; ER2: 27 ROIs).l, Receptive field ellipse ratios as a function of ellipse angles. Ellipse ratio medians of ER4d and ER2 are significantly different (P= 0.0030, Wilcoxon rank sum test).m, Polar histograms of ellipse angles. The ellipse angles are not uniformly distributed (ER4dP= 4.673 × 10−14, ER2P= 0.0033, Rayleigh’s test for nonuniformity).

*** Source Data

*** By contrast, back-tracing starting from single ER2_ad and ER2_b neurons revealed that they receive information from MeTu3c neurons with dendrites located in the dorsal medulla (Fig.4eand Supplementary Video2), whereas individual ER2_c neurons receive inputs exclusively from MeTu3c neurons with dendrites in the central medulla (Supplementary Video3). Similar to the channel converging into ER4d neurons, the MeTu3c populations upstream of ER2_ad, ER2_b and ER2_c neurons tile the entire visual field. In other words, the ER2 population tiles the visual field two-dimensionally, providing more organizational details of the scene in two dimensions than do ER4d neurons (Fig.4e).

*** Furthermore, the roles of ER4d and ER2 in processing chromatic information might differ: Dm2, the main upstream input of MeTu1, receives inputs predominantly from UV-sensitive pale photoreceptors37(81%), which suggests that ER4d neurons could process UV stimuli. On the other hand, Mi15, the main upstream input of MeTu3c, receives input from green-sensitive yellow R8 photoreceptors37(67%), which suggests that ER2 neurons process longer-wavelength stimuli.

*** Unlike the ER4d and ER2 populations, ER4m and ER5 neurons receive strong input from polarization-sensitive channels involving the DRA-specific MeTu2a (both ER4m and ER5) and MeTu2b (ER5) neurons, respectively. As described before, MeTu2b exhibits more complex connectivity than MeTu2a and, therefore, might encode complex features of polarized light. Hence, ER5 might process more complex features of polarized skylight, whereas ER4m seems to process skylight polarization alone as a navigational cue, consistent with a previous report11. This difference is notable because ER5 is involved in circadian rhythms54,55.

*** ER3w receives input from MeTu3a and MeTu3b neurons, potentially combining skylight polarization information (from both MeTu3a and MeTu3b; Extended Data Fig.6a,b) and localized visual feature information from some of the dorsal visual field (Fig.4e). On the other hand, most other ER3 subtypes with dendrites in the inferior bulb are downstream of MeTu4 subtypes that do not receive columnar input in the medulla. Thus, until the functions of upstream neurons (Extended Data Fig.8e) are understood, the visual area and features that these ER3 neurons encode will remain unclear.

*** Overall, we predict that ER neurons downstream of MeTu1–MeTu3 neurons encode diverse information including polarized light (ER4m, ER5 and ER3w), vertical stimuli or the azimuthal location of visual features (ER4d), and the two-dimensional organization of visual scenes, including azimuth and elevation (ER2), a system suitable for processing both the elevation of a celestial body (for example, the Sun)56and the surrounding two-dimensional environment7.

*** We performed two-photon calcium imaging to test some of these predictions, especially the spatial extent of the visual field to which ER4d and ER2 neurons respond (that is, the receptive field; Fig.5). We imaged the dendritic calcium activity of ER neurons in the superior bulb while presenting square-shaped dot stimuli to the fly using a projector-based visual stimulation set-up (Fig.5c–e). Both ER neuron types were excited by ipsilateral visual stimuli, consistent with previous studies6,9,12,39(Fig.5f,g). The ellipse contours of the receptive fields of ER4d and ER2 tile the visual space differently (Fig.5h–k). As predicted by our connectomic analysis, the receptive fields of ER4d neurons are vertically elongated (76 ± 13° (1 s.d.) in height and 31 ± 12° in width), and tile the visual space horizontally. The receptive fields of ER2 neurons, on the other hand, are markedly smaller (59 ± 13° in height and 30 ± 9° in width) and tile the visual space in two dimensions. These results precisely match our predictions about the spatial extent of these neurons’ receptive fields. Note that the vertical extent of the ER4d receptive fields is much greater than that reported previously6; we believe this to be because of the limited span of elevation in the set-up used previously. By contrast, we tilted the fly head to expose the eyes to more vertical visual span. These results show that informed, systematic predictions can guide experimental designs to reveal previously unexplored dimensions of neural functions.

*** We observed four essential organization principles of the AVP: (1) a convergence of spatial information from MeTu to TuBu, which suggests the compression of visual information into features with coarse spatial resolution; (2) segregated and parallel processing of spatially overlapping visual features in largely feedforward circuits; (3) parallel pathways for interhemispheric integration, selectively mixing visual features; and (4) divergent feature expansion through TuBu-to-ER connections (Extended Data Fig.11). Furthermore, by back-tracing from ER neurons to MeTu neurons, we inferred the diverse visual features that compass neurons might use to compute the head direction (Extended Data Fig.13).

*** Our analysis of the reconstructed synaptic pathways reveals that the fly’s visual field can be roughly subdivided into three regions: a narrow band in the dorsal-most visual field (DRA)11,35,50; the remaining upper visual field (both of these two regions are facing the sky); and the rest of the visual field (the equator and ventral field). Of note, the DRA and upper visual fields are occupied by the large majority of MeTu neuron types with overlapping receptive fields (MeTu1, MeTu2a and MeTu2b, MeTu3a and MeTu3b, and MeTu4a and MeTu4b); by contrast, the lower and frontal visual fields are served by lower numbers of cells and subtypes (innervated by MeTu1, MeTu3c, MeTu4c and MeTu4d). In particular, MeTu4d neurons cover only the ventral half of the visual field. We speculate that this serves to process ventral optic flow57or to orient towards shiny surfaces (for example, water) that produce horizontally polarized reflections49,58, which flies detect and use to adjust their body orientation59,60. Nine out of the ten parallel information channels formed by MeTu neurons seem to maintain only azimuth information, discarding information about elevation; this strategy seems particularly efficient for computing a heading in azimuth. Only the MeTu3c channel may encode both azimuth and elevation—a property that seems ideal for perceiving the two-dimensional organization of the surrounding environment or for tracking the position of the celestial body across the day. Overall, these organizational patterns of the AVP suggest thatD. melanogasterprioritizes the azimuthal position of celestial cues, including the skylight polarization pattern.

*** Animals exhibit specific cue preferences during navigation, and we have long known that visual features are processed hierarchically16: Dung beetles prioritize skylight polarization or sun location depending on the environmental context1, and mammals prioritize the geometry of the surrounding space2,3. However, the field is only just beginning to investigate which visual features are extracted and how they are prioritized across insects4,43and mammals2. As such, our complete reconstruction of the AVP in flies is essential for mechanistically understanding the circuit implementation and shared functional principles that underlie the prioritization, integration and transformation of this information into a heading signal. This is exemplified by our experiments that physiologically confirm some of the new predictions. Furthermore, with the ability to dissect detailed circuit dynamics of neural populations using the rich genetic tools in flies, we are poised to gain a deeper understanding of how sensory information is transformed into more abstract representations, which is fundamental to and essential for higher cognitive functions in the brain.

*** Our study analysed the FAFB, an adult femaleD. melanogasterbrain imaged at the synaptic level resolution with serial section transmission electron microscopy17. We used the FlyWire interface, which auto-segmented FAFB EM data to construct three-dimensional segmentations of individual neurons29. To reconstruct desired neurons, we first identified relevant axons, dendrites and branches. Possible errors by the auto-segmentation were mainly unfinished branches caused by missing EM slices or incorrect connections caused by shifted EM slices. In addition, some neurons had darker cytosols in the EM data, possibly owing to neuronal damage during the dissection process61, and were therefore not as well-constructed by the auto-segmentation. We manually corrected each of these errors.

*** To find all MeTu, TuBu, TuTu and AOTU046 neurons in the AVP, we densely reconstructed the AOTUsu by scanning through every layer of EM in the neuropil volumes and proofreading all neurons composing them (disregarding twigs). ER neurons were identified by following TuBu downstream connectivity30. After each of these neurons was proofread, we classified them and compiled lists of their coordinates for further analysis. See Supplementary Table1for details of the editing and naming history.

*** Regions were distinguished in our study so as to limit synapses to specified neuropils. These regions included ME_L, ME_R, LO_L, LO_R, AOTU_L, AOTU_R, BU_L, BU_R and EB (in which ME indicates medulla; BU, bulb; LO, lobula; L, left; R, right; and EB, ellipsoid body). Using SciPy’s spatial module, we created Delaunay tessellations using a set of FlyWire coordinates to determine whether synapses were contained within the given regions. The sets of points were not a comprehensive boundary box of individual neuropils, but rather formed polyhedra that contained the ROIs of the relevant neurons. The coordinates were selected with the help of FlyWire’s annotation lines to ensure that all neurons’ synapses were incorporated. In the case of the medullas, in which the Delaunay tessellation incorporated some lobula synapses as well, the ipsilateral lobula region was subtracted.

*** The connectome of the AVP, which revealed four major MeTu types, clarifies discrepancies in previous literature. MeTuimin Omoto & Keleş et al.39seems to be MeTu4 because DALcl2d TuBu neurons project from AOTUimto the inferior bulb (BUi). In addition, on the basis of spatial organization, AOTUlc, AOTUlpand AOTUla/ilin Omoto & Keleş et al. might correspond to MeTu1, MeTu2 and MeTu3 locations, respectively, although the AOTUsu map is slightly different from our study (Extended Data Fig.1d). A crucial discrepancy we could not resolve was TuBuain Omoto & Keleş et al. They described that TuBuaprojects from AOTUilto the anterior BU (BUa), which we did not observe in the FAFB dataset. In Hulse, Haberkern, Franconville and Turner-Evans et al.16, the TuBu neuron type innervating the BUais TuBu01, which are located in AOTUsu_PC, downstream of MeTu2. However, Omoto & Keles et al. say that these TuBu neurons project from the AOTUsu_A to the BUa. We believe that this discrepancy is due to the lower resolution of light microscopy, and think that TuBuashould be reclassified.

*** Timaeus et al.14divided the AOTUsu into five subdomains, separating the AOTUsu_A into lateral and anterior central parts. They state that R7 might be upstream of MeTula, MeTucaand MeTucp(MeTu3 and MeTu2, respectively), which agrees with what we found. However, they only found TuBu neurons projecting from the AOTUsula, AOTUsulp, AOTUsucaor AOTUsucpto the BUsand the AOTUsumto the BUi, meaning that they did not discover TuBu01. Finally, they found that MeTum(MeTu4) dendrites also projected to medulla layers 2 and 8, which was inconsistent with what we found in the FAFB dataset.

*** Tai et al.15, unlike the other two papers, found four subdomains of the AOTUsu (L-AOTU1–4), which are connected linearly from the edge of the AOTUlu to the lateral-most edge of the AOTUsu. The respective MeTu neurons in these regions were called MT1–4(not corresponding to our study’s MeTu1–MeTu4). This study only showed an anterior view of the AOTU, and as such, it is possible that they did not find the AOTUsu_PC, which is obscured by the AOTUsu_A from the anterior side. In this case, the corresponding regions are AOTUsu_M (L-AOTU1), AOTUsu_A (L-AOTU2–3) and AOTUsc_PL (L-AOTU4). The corresponding MeTu neurons are thus MeTu4a, MeTu4b, MeTu4c and MeTu4d (MT1), MeTu3c (MT2), MeTu3a and MeTu3b (MT3) and MeTu1 (MT4).

*** Synaptic connectivity between neurons was found using automatic synapse detection30. For all our connectivity analyses, we used a cleft score of ≥50 and excluded autapses and synapses to the background segmentation. Two types of connectivity matrices were generated throughout the study: Supplementary Data1a–gshow individual neuron weight matrices (purple) and neural type weight matrices (green). For the individual neuron weight matrices (Supplementary Data1a–d), the number of synapses between each neuron was first calculated. To determine the relative weight within the given region, this quantity was divided by the postsynaptic neuron’s total number of synapses in the region.

*** Certain outlier neurons heavily skewed the colour plot matrices because they had few connections in their respective regions or nearly exclusively received synaptic weight from a single neuron. To resolve the former issue, neurons with fewer than five total regional connections were not included in the matrices. To resolve the latter issue, a small number of outliers were removed from medulla MeTu interconnectivity plots: one MeTu1_R, one MeTu2a_R and three MeTu4a_R.

*** The ordering of the neurons within the connectivity matrices was based on the location of TuBu neurons along the dorsal–ventral axis within the AOTUsu. Both MeTu and ER neurons were ordered in groups according to which of these TuBu neurons they were most connected to (MeTu neurons presynaptically in the AOTUsu and ER neurons postsynaptically in the bulb). Within the groups they were ordered by how many synapses they shared with that TuBu neuron.

*** Neural type weight matrices (Supplementary Data1e–g) show the connections of whole classes of neurons. First, the total number of synapses between all presynaptic and postsynaptic neurons of the respective given types was calculated. Then, these quantities were divided by the total number of synapses of all postsynaptic neurons of the given type within the region. This gave a measure of the total synaptic weight between the two types.

*** Three-dimensional renderings were either generated in Blender with neuron meshes retrieved using the Python CloudVolume package or in R with the rgl and fafbseg package.

*** We identified all Mi1 neurons, a unicolumnar cell type, in both hemispheres as a proxy for individual medulla columns because Mi1 neurons are present in each medulla column and span the entire distal–proximal axis of the medulla from layer M1 to layer M10. For each Mi1 neuron we performed a principal component analysis (PCA) on all pre- and postsynaptic sites of the neuron (Extended Data Fig.1e). PC1 corresponds to the distal–proximal axis of the column. The upper and lower boundary of each column is defined as the 0.03 and 0.97 percentile of synapses on the distal–proximal axis.

*** Medulla layers are based on the average synapse distribution of Mi1, Mi4, L1, L2, L3, L5, Dm8 and T4 neurons along the distal–proximal axis in three exemplar columns. Layer M1: [−3.9–5.5%]; layer M2: [5.5–17.1%]; layer M3: [17.1–30.8%]; layer M4: [30.8–34.0%]; layer M5: [34.0–43.2%]; layer M6: [43.2–50.1%]; layer M7: [50.1–63.1%]; layer M8: [63.1–75.4%]; layer M9: [75.4–92.4%]; layer M10: [92.4–102.2%].

*** We describe MeTu types (labelled with numbers: MeTu1–MeTu4) and MeTu subtypes (labelled with lowercase letters; for example, MeTu2a). MeTu1, MeTu2 and MeTu3 were previously called MC61 (ref.62) and MeTu4 was called MC64 (ref.16). MeTu2 was also called MeTu-DRA37. The location of axons and dendrites of MeTu (Fig.1c), TuBu (Fig.1c), TuTu (Extended Data Fig.4) and AOTU046 (Extended Data Fig.4) neurons maintain specific patterns of processes within the AOTUsu16, through which we determined four distinct regions (posterior lateral, posterior central, anterior and medial). The axonal boutons of each MeTu neuron terminate within one of these four areas, so we classified MeTu1, MeTu2, MeTu3 and MeTu4 as types. Between the left and right hemispheres, respectively, there are 121 and 124 MeTu1, 50 and 50 MeTu2, 145 and 129 MeTu3 and 137 and 138 MeTu4. There was one neuron on the right side whose axonal tract terminated before projecting to the medulla. It was labelled MeTu_incomplete_R and was excluded from further analysis.

*** Analysis of morphology, up- and downstream connectivity as well as spatial distribution in the medulla revealed distinct MeTu subpopulations within MeTu2, MeTu3 and MeTu4, which led us to define MeTu subtypes.

*** MeTu1 forms a homogenous neuron population in terms of morphology, and up- and downstream connectivity, without any distinctive features that would allow any further subtyping (Fig.2m). MeTu2a is connected to both TuBu01 and TuBu06 with a preference for TuBu01, while MeTu2b is primarily connected to TuBu06 with very few synapses onto TuBu01 (Extended Data Fig.5k).

*** We found three MeTu3 subtypes: MeTu3a, MeTu3b and MeTu3c. MeTu3a has flat dendrites and lacks presynaptic connections to Mi15, whereas MeTu3b and MeTu3c have vertical dendritic protrusions and connect to Mi15 (Extended Data Fig.5d,e). MeTu3a was specifically classified as MeTu3 that has 13 or fewer synapses with Mi15 neurons. Note that MeTu2a and MeTu2b cell bodies are located closer to the medulla equator, whereas MeTu3a cell bodies are found above the centre of the branching (data not shown). Within the AOTUsu, all MeTu3a project to TuBu07. MeTu3b is strongly connected to TuBu07, and MeTu3c is most strongly connected to TuBu09 and TuBu10. To further analyse this distinction, we compared their postsynaptic weights with Mi15, Sm17, Sm23 and MeMeDRA. Some MeTu cells sensitive to skylight polarization have so far been physiologically characterized inDrosophila11, and a careful comparison between their light microscopic data and our connectomic reconstruction identifies these cells as MeTu2b and MeTu3a. Finally, MeTu3c might have subpopulations: MeTu3c_dorsal and MeTu3c_ventral, on the basis of the TuBu connectivity. Their connectivity in the medulla was indistinguishable other than the general location (dorsal medulla versus ventral medulla), which might suggest the same kind of information processing. Furthermore, the axons to downstream TuBu09 and TuBu10 overlap somewhat, suggesting that functional differences may occur downstream of—but not at—the MeTu3c neurons. For these reasons, we decided to combine them into a single subtype.

*** MeTu4 is generally morphologically distinct from other MeTu types because neurons contain boutons within the lobula. However, light microscopy suggested there is a subtype that does not have these boutons (Extended Data Fig.8h). We also found a MeTu4 population without lobula boutons and few lobula synapses (fewer than 15 pre- and postsynapses), which we named MeTu4d. MeTu4d in addition only arborizes within the ventral half of the medulla.

*** We further grouped MeTu4 neurons with lobula boutons into distinctive subtypes on the basis of downstream TuBu connectivity. MeTu4a are presynaptic to TuBu03 and TuBu04, MeTu4b are presynaptic to TuBu02 and MeTu4c are presynaptic to TuBu05.

*** UMAP in Fig.1f(top) is based on connectivity to up- and downstream partners as features. We selected a total of 84 neurons (see ‘Upstream connections’ for more information). Downstream neurons include 13 types (all TuBu types, TuTuA, TuTuB and AOTU046), and upstream neurons include 28 types (all top 5 connected neuron types of all MeTu subtypes. UMAP in Fig.1fiiis based only on the 31 upstream types (28 non-MeTu and 3 MeTu types). All connectivity types are also shown in Fig.1g.

*** As the entire optic lobe connectivity became available (FlyWire v.783)45, we also performed the same analysis using the entire dataset in the right hemisphere (Supplementary Data1h).

*** Finally, we sought to provide light microscopic evidence in the form of cell-type-specific driver lines, corroborating the existence of the genetically defined subclasses of visual projection neurons that are described in this study33,34,63,64(see Supplementary Table2).

*** For a subset of MeTu neurons described in the previous section, we increased the proofreading quality by increasing the rounds of detailed proofreading29. We used the right optic lobe because the left optic lobe has a partially detached lamina and parts of the posterior side of the medulla are distorted17. We chose 113 of the 441 right MeTu neurons to undergo multiple rounds of proofreading. Originally, 101 neurons were chosen randomly with the same relative ratios of MeTu1–MeTu4 neurons as in the population: 28 MeTu1, 12 MeTu2, 30 MeTu3 and 31 MeTu4. When we later discovered subcategories of the neurons, we wanted at least five of each subtype. In the end, we proofread the following 113 neurons: 29 MeTu1, 7 MeTu2a, 5 MeTu2b, 6 MeTu3a, 13 MeTu3b, 16 MeTu3c, 13 MeTu4a, 5 MeTu4b, 14 MeTu4c and 5 MeTu4d.

*** Each of these neurons underwent three rounds of proofreading, and synaptic and skeletal comparisons were performed to determine the differences in accuracy between the three rounds. The first round was the cursory proofreading that was done to all 441 MeTu neurons. The next two rounds were split between the two proofreaders (D.G. and E.K.). Each proofreader densely proofread half of the 113 for the second round, and then switched and worked on the other half for the third round. Afterwards, F1 scores were computed on both the number of synapses and the number of skeletal nodes of each neuron between rounds. These scores showed the decrease in the number of edits between the first round and subsequent rounds.

*** We used automatic synapse detection to find presynaptic partners of the proofread MeTu neurons. As stated in the proofreading section, we picked them on the basis of the ratio of the entire population, with a minimum of five neurons per type. In addition, as with the proofreading rounds, we only looked at neurons on the right side. Because several neurons contain a darker cytosol and are not segmented well in FlyWire, we left out any of those neurons in favour of normal neurons. Thus, we analysed the following 84 neurons: 18 MeTu1, 5 MeTu2a, 5 MeTu2b, 6 MeTu3a, 9 MeTu3b, 11 MeTu3c, 10 MeTu4a, 5 MeTu4b, 10 MeTu4c and 5 MeTu4d. For each neuron, we identified all upstream partners with five or more synapses. Many partners had been classified in previous studies, and for any others we used a nomenclature proposed recently45.

*** MeTu and TuBu synapse density maps in the AOTUsu were created from three angles: from the dorsal side looking towards the ventral side; from the anterior side looking towards the posterior side; and from the lateral side looking towards the medial side (Extended Data Fig.3a,b). Each of these views was rotated 30° along the anterior–posterior axis. Each map was created by finding all of the connections within small volumes, each 40 nm by 40 nm by the length of the AOTUsu along the viewpoint axis. When the number of connections was computed, they were subjected to a Gaussian blur with a sigma value of 10. Colour maps were then created on the basis of the relative values, with higher values having higher opacity. Demonstrative synapse maps were created as well (Fig.1c). These were subjected to a Gaussian blur (with a sigma value of 4), and did not vary in opacity according to synapse density.

*** We used the neurotransmitter prediction described in a recent study51. We calculated the average neurotransmitter probability across all presynaptic sites of an individual neuron (Extended Data Figs.4c,eand12).

*** The existing connectomic analysis16of the hemibrain65,66provided full classifications of TuTu, TuBu and ER neurons, which we adopted in this study. This study gave detailed classifications to 17 bulbar ER neurons and 5 lateral accessory lobe ER neurons. Of the 17 bulbar neurons, there are 11 distinct morphologies, and we classified the FAFB neurons as follows: ER2_abd, ER2_c, ER3a_ad, ER3d_acd, ER3d_b, ER3m, ER3p_ab, ER3w. ER4d, ER4m and ER5. The study also described patterns of interconnectivity between ER neurons, and using synaptic analysis we distinguished ER2ad and ER2b, and ER3d_a, ER3d_c and ER3d_d. There are multiple morphologies of ER2c neurons (which is consistent with hemibrain), but we did not further subcategorize these neurons. However, some connectivity patterns are not consistent between the hemibrain and FAFB, so we did not subclassify all neurons to the same level of detail. In the instances of ER2_a and ER2_d; ER3a_a and ER3a_d; ER3p_a and ER3p_b; and ER3w_a and ER3w_b, we maintained their names as ER2_ad, ER3a_ad, ER3d_acd, ER3p_ab and ER3w_ab.

*** In the hemibrain, TuBu neurons were classified on the basis of their downstream ER neuron partners. After classifying all the corresponding ER neurons, we similarly grouped the TuBu neurons as TuBu01–TuBu10. There are three ambiguous TuBu neurons. One TuBu in the right hemisphere is upstream of an ER2c neuron but is located in line with other TuBu09 as opposed to TuBu10, which are generally upstream of ER2c. We labelled this neuron TuBu09 because of its location in AOTUsu. Another TuBu neuron in the right hemisphere has the dendritic morphology of a TuBu04 and is downstream of MeTu4a, but is upstream of ER3p_ab. We classified it as TuBu04 as opposed to TuBu05. One neuron in the left hemisphere has a normal microglomerulus partnered with an ER3a_ad and two ER3m neurons like TuBu02 neurons. However, this neuron projects to the SPS, as opposed to the AOTUsu. Because there is no other neuron in this dataset or hemibrain with this projection pattern, we determined that it might have been a developmental error and labelled it TuBu_misc_L, only including it in connectivity tables between TuBu and ER neurons.

*** We identified TuTub_a and TuTub_b on the basis of morphology. There is one of each type per hemisphere. There are four AOTU046 neurons, with dendrites in one SPS and axons in both AOTUsu and both bulbs. The quantity of each of these bihemispheric neurons is consistent with hemibrain16.

*** Connectivity diagrams of bihemispheric neurons are based on type connectivity matrices from the right hemisphere (Extended Data Fig.4a). Each arrow represents the weight of the postsynaptic neuron type’s connection to the presynaptic neuron type. Only weights ≥0.05 were represented as arrows. Arrow thickness was determined linearly on the basis of the weight.

*** The bihemispheric neuron diagrams in Extended Data Fig.4b,dare made using neurons from the right hemisphere. Pie charts within the figures show the relative amount of presynaptic (red) and postsynaptic (cyan) connections of the neuron. Within the AOTUsu, these only include connections between the bihemispheric neurons and MeTu and TuBu neurons. Within the bulb, the connections shown are between AOTU046 and TuBu and ER neurons. Within the SPS, the connections are between AOTU046 and all SPS neurons. The relative size of the pie charts refers to the quantities of bihemispheric synapses in each subregion. In the case of AOTU046, these were calculated by averaging the two neurons on the right side. Lines are drawn to subregions that have 100 or more synapses.

*** To identify other potential visual pathways, we looked up to two hops upstream of central complex input neurons (Extended Data Fig.2). We excluded neurons intrinsic to the central complex. For upstream partners, we included neurons that had at least five synapses with their downstream partner. After finding all neurons one to two hops upstream of the central complex input neurons, we determined which of them contained dendrites within optic lobe neuropils. This number of hops was selected to match the number of hops of the direct pathway from MeTu to TuBu to ER neurons. When calculating optic lobe weights, we summed the relative proportion of synapses that came from those optic lobe neurons. Renders of alternate pathways included the central complex neurons, upstream neurons that are either optic lobe neurons or neurons with upstream optic lobe partners, and those upstream optic lobe partners. The renders only contained these neurons if they accounted for ≥1% of the total non-central complex synaptic weight of their postsynaptic partner.

*** We used microCT data53to assign each medulla column to an ommatidia. We determined the directions of ommatidia to the world as previously described53. Separately, we counted the numbers of R1–R6 photoreceptors in the lamina to identify the equatorial medulla columns, which have seven or eight photoreceptors compared to six in non-equatorial columns (data not shown). We then mapped ommatidia and medulla columns to separate hexagonal grids. Finally, using the equator as a reference, we aligned these hexagonal grids by minimizing unmatched points, hence assigning each medulla column a viewing (or sampling) direction in the visual field.

*** For each ‘visual column’ of a given ER neuron, we calculate the values for the direct pathway as the sum of all weighted branches connecting the ER neuron via TuBu and MeTu neurons to the ‘visual column’ (Fig.4a, middle). Each branch is the product of synaptic weights of TuBu neuron to ER neuron connection, MeTu neuron to TuBu neuron connection and MeTu neuron medulla column occupancy. MeTu neuron medulla column occupancy is calculated as the fraction of presynaptic sites closed to the column. The values for the indirect pathway are the sum of all weighted branches connecting the ER neuron via TuBu, TuTuB and MeTu neurons to the ‘visual column’ (Fig.4b, middle). We overlaid the values for the direct and the indirect pathways with different colours (Fig.4c,e).

*** The hemibrain dataset contains the entire central complex of theD. melanogasterbrain, but only extends to include the AOTU of the left hemisphere. Therefore, it contains two sets of ER neurons, one set of TuBu neurons and only the boutons of one set of MeTu neurons. The MeTu neurons were named MC64 or MC61.

*** We used the Python module neuprint-python to look at the MC61 and MC64 that are presynaptic to the previously defined TuBu neurons. We first distinguished MeTu1–MeTu4 on the basis of their respective TuBu types. All MC64 are MeTu4, but a small population of MeTu4 was MC61 instead. We plotted the number of synapses within the lobula among MC61 and MC64 to determine that this distinction was due to differences in the number of lobula connections (data not shown). We distinguished MeTu4 in the same way as for FAFB, in which fewer than 15 synapses in the lobula denoted MeTu4d. We classified all other MeTu subtypes using their downstream TuBu partners. The only classification we were unable to make was that of MeTu3a and MeTu3b, because they were separated using upstream connections in the medulla, which the dataset did not include. We labelled these neurons MeTu3ab, and adjusted the FAFB one in comparison plots. After classification, there are 127 MeTu1, 39 MeTu2a, 14 MeTu2b, 64 MeTu3ab, 86 MeTu3c, 68 MeTu4a, 13 MeTu4b, 41 MeTu4c and 17 MeTu4d.

*** After obtaining all AVP neurons in FlyWire and neuprint, we compared the relative numbers of neurons among four hemispheres with ER and bihemispheric neurons, and three hemispheres with TuBu and MeTu neurons. We noticed discrepancies among TuBu and ER neuron counts, so we compared the ratios of ER to TuBu counts in the three hemispheres (Extended Data Fig.9e,f).

*** To support the EM-based cell typing and to provide genetic tools for future studies of MeTu neurons, we report several split-GAL4 lines with preferential expression in subsets of MeTu types. These split-GAL4 lines were generated before the EM work; that is, are the output of an independent, light-microscopy-based effort to characterize MeTu cell types but are newly reported here. Driver lines and their candidate EM matches are listed in Supplementary Table2. Figures show processed images displayed using VVD viewer (https://github.com/JaneliaSciComp/VVDViewer/releases). Lines and original image data are available athttps://splitgal4.janelia.org/cgi-bin/splitgal4.cgi. Some lines are not currently maintained as stocks but can be reconstructed from the AD and DBD hemidrivers.

*** The general strategy and methods to generate and characterize these lines were as described for other split-GAL4 lines33,63. In brief, we searched for GAL4 lines with expression in MeTu cells using images of GAL4 driver expression patterns67,68,69, then screened the expression patterns of hemidriver (AD, DBD) combinations selected to target candidate MeTu types on the basis of these searches, and constructed stable fly lines for combinations with patterns of interest. Further characterization of these lines included imaging of overall expression patterns and, in most cases, of MCFO-labelled individual cells. Sample preparation and imaging, performed by the FlyLight Project Team using protocols available athttps://www.janelia.org/project-team/flylight/protocols, were as in previous work34,70. For an overview of the Janelia FlyLight split-GAL4 project, see a previous study64. Some additional MeTu driver lines that are not included here are also available47.

*** All experiments were performed with seven-to-nine-day-old female flies. Blinding was impossible, and thus was not performed, because the morphology of the neurons is easily recognizable during imaging for each type of neurons. We did not perform sample size calculation but collected data from a fixed predetermined number of flies. Before experiments, flies were prepared as previously described6. In brief, a fly was anaesthetized on ice and transferred to a cold plate. The proboscis of the fly was pressed into the head and fixed with wax. In addition, the front and middle pairs of legs were removed. The fly was glued to a pin and positioned in a pyramid-shaped holder. We tilted the fly head 30–45° to the left and glued it to the holder with UV-curable gel. Next, we removed the cuticle on the head, together with ocelli and trachea, to expose the central brain for optical access. Muscle 16 was severed using a dissection needle to reduce brain movement. To further stabilize the brain and minimize motion, we covered the exposed brain with around 3 µl of saline with 3% low-gelling point agarose (Sigma-Aldrich), which was adopted from an imaging procedure ofDrosophilaKenyon cells71. The brain was bathed in saline, as described in previous studies5, with an adjusted calcium concentration at 2.7 mM. The fly was then transferred to the microscope for recording.

*** Visual stimuli were rear-projected onto a Teflon screen (0.254 mm thick, McMaster-Carr, item 8569K18) placed at the anterior-left-ventral side of the fly with a 45° inclination. We used a customized projector (Texas Instruments) with filters (AVR) to display blue stimuli with a wavelength peak at 450 nm. The stimuli were displayed at a frame rate of 60 Hz and a resolution of 1,028 × 960. A photodiode was placed on the edge of the screen to detect a small flashing square for synchronization between the visual stimuli and calcium activity72. Visual stimuli were drawn and displayed by Psychtoolbox-3.

*** We used a custom-built two-photon scanning microscope (Janelia MIMMS 2.0) with a 40× objective (Nikon, NA 0.8, 3.5 mm WD). We used a Chameleon laser tuned to 930 nm with a maximum power of 10 mW for excitation and detected fluorescence by a GaAsP photomultiplier tube. We imaged the superior bulb over 15 focal planes, each separated by 1 µm, acquired at a volume rate of about 10 Hz at a resolution of 128 × 128.

*** All data processing and analyses were performed in MATLAB. We corrected for brain movement inxydirections by registering individual frames to the reference image using a cross-correlation algorithm. We generated reference images in Fiji by summing up images across the time series. We manually identified individual microglomeruli as an ROI on the basis of the videos of fluorescence changes, and we subtracted the mean fluorescence of an empty ROI from the same frame for each frame to compensate for noise. We defined the baseline fluorescence (F0) as the lowest 10% signal throughout the experiment. Because each microglomerulus does not occupy the entire depth of 15 planes in a volume, we averaged fluorescence from three consecutive planes and used the strongest value among 13 values in each volume asF, to calculate the ΔF/F0.

*** The fly was presented with a square-shaped dot for 1 s followed by 1 s of darkness. The dot was randomly chosen from a set of 38 pre-indexed dots, which were 18° by 18° each in size and were not spatially overlapping. Each dot was tested for ten trials. In each trial, we calculated the response by subtracting the mean ΔF/Fduring the 1-s stimulation period from the mean ΔF/Fduring the 500 ms before a dot appeared. We used the average response over ten trials to plot the receptive field. If the average response had either aPvalue higher than 0.05 in the Wilcoxon signed-rank test or a change smaller than the response of an empty ROI, we considered it unresponsive. We quantified the properties of an excitatory receptive field by fitting an ellipse into it by using the regionprops function in MATLAB.

*** Further information on research design is available in theNature Portfolio Reporting Summarylinked to this article.

